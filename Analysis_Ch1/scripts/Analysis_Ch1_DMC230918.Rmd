---
title: "Analyses for Ch1 of Big Report"
author: "DMC"
date: "2023-09-18"
---

Here is the script to prepare raw data for QC.

```{r import FRP data}
rm(list = ls())
load(here::here("imports", "QCd_Data_FRP.RData"))

# create a new list of qc'd data frames to be filtered by year
list_all <- list_all_qc

for(i in 1:length(list_all_qc)){
  #list_2022 <- list() # temporary list
  for(j in 1:length(list_all_qc[[i]])){
    
    rtd_sondeID <- strsplit(names(list_all_qc[[i]])[j], split = " ", fixed = TRUE)[[1]][1] # variable for sondeID
    rtd_dateDeploy <- as.numeric(substr(strsplit(names(list_all_qc[[i]])[j], split = " ", fixed = TRUE)[[1]][2],0,4)) # variable for Deployment date
    rtd_dateRecov <- as.numeric(substr(strsplit(names(list_all_qc[[i]])[j], split = " ", fixed = TRUE)[[1]][3],0,4)) # variable for Recovery date                              0)
    if((rtd_dateDeploy >= 2023 & rtd_dateRecov >= 2023)){
      list_all[[i]][[j]] <- list(NULL)
    } else {
      skip_to_next <- FALSE
      tryCatch({
      list_all[[i]][[j]] <- list_all_qc[[i]][[j]][,c("Site","dts","TempC","SPC","DOmgL","Turb","TempC_qcE","SPC_qcE","DOmgL_qcE","Turb_qcE","Depthm")]
      },
      error = function(e){ skip_to_next <<- TRUE})
      if(skip_to_next) {next}
    }
    rm(rtd_sondeID, rtd_dateDeploy, rtd_dateRecov)
  # when an error is encountered, the loop will be forced to continue and the warning(s) will be shown at the end
  }
}



FLYW <- do.call(rbind.data.frame, list_all[[1]])
FLYW$dts2 <- lubridate::floor_date(FLYW$dts, "15 minutes")
DECK_pool <- do.call(rbind.data.frame, list_all[[2]])
DECK_pool$dts2 <- lubridate::floor_date(DECK_pool$dts, "15 minutes")
DECK_breach <- do.call(rbind.data.frame, list_all[[3]])
DECK_breach$dts2 <- lubridate::floor_date(DECK_breach$dts, "15 minutes")

save(DECK_breach, DECK_pool, FLYW, file = here::here("working","ImportedRaw.RData"))
```


```{r get 1 file for FRP DECK}
library(ggplot2)

rm(list = ls())

load(here::here("working","ImportedRaw.RData"))
'%ni%' = Negate('%in%')

# DECK_breach$Depthm_BR <- DECK_breach$Depthm
# DECK_breach$TempC_BR <- DECK_breach$TempC
# DECK_depthdiff <- merge(DECK_pool, DECK_breach[,c("dts2","TempC_BR","Depthm_BR")], by = "dts2")
# DECK_depthdiff$diff_Depth <- as.numeric(DECK_depthdiff$Depthm) - as.numeric(DECK_depthdiff$Depthm_BR)
# DECK_depthdiff$diff_Temp <- as.numeric(DECK_depthdiff$TempC) - as.numeric(DECK_depthdiff$TempC_BR)
# plo_depth <- ggplot(DECK_depthdiff[which(DECK_depthdiff$diff_Depth < 10 & DECK_depthdiff$diff_Temp > -20),], aes(x = dts2, y = diff_Depth)) +
#   #geom_point()#+
#   geom_point(data = DECK_depthdiff[which(DECK_depthdiff$diff_Depth < 10 & DECK_depthdiff$diff_Temp > -20),], aes(x = dts2, y = diff_Temp), color = "red")

DECK_breach.2 <- DECK_breach[which(DECK_breach$dts2 %ni% DECK_pool$dts2),]
DECK_pool$TempC <- as.numeric(DECK_pool$TempC)
DECK_breach.2$TempC <- as.numeric(DECK_breach.2$TempC)

plo <- ggplot(DECK_pool, aes(x = dts2, y = TempC)) +
  geom_point(color = "black", alpha = 0.2) +
  geom_point(data = DECK_breach.2, aes(x = dts2, y = TempC), color = "red", alpha = 0.2)

#DECK <- rbind.data.frame(DECK_pool, DECK_breach.2)
DECK <- DECK_pool

load(here::here("working","USGS_DeckerTogether.Rds"))
load(here::here("working","USGS_ToeDrain.RData"))

TOED <- df_ToeDrain
TOED$dts2 <- TOED$dateTime
TOED$Depthm <- 1
SACR <- USGS_DECK.2
SACR$dts2 <- SACR$dateTime
SACR$Depthm <- 1

list_all <- list(FLYW, DECK, TOED, SACR)
names(list_all) <- c("FLYW", "DECK", "TOED", "SACR")

save(list_all, file = here::here("working","All_Raw.RData"))
save(DECK, FLYW, file = here::here("working","FRP_Raw.RData"))
```


```{r}
library(ggplot2)
rm(list = ls())
load(here::here("working","All_Raw.RData"))

xSite <- names(list_all)
cols.num <- c("TempC","DOmgL","SPC","Turb")
list_all_4qc <- list()
for(i in 1:length(xSite)){
  df <- list_all[[xSite[i]]]
  df$Site2 <- names(list_all)[i]
  df[cols.num] <- sapply(df[cols.num], as.numeric)
  rownames(df) <- NULL
  dfDUP <- df[duplicated(df$dts2),]
  if(nrow(dfDUP) >0){
    df.2 <- df[-which(duplicated(df$dts2)),]
    if(xSite[i] == "DECK"){
      df.3 <- df.2[-which(is.na(df.2$dts2)==T | df.2$TempC <0.9),]
    } else {
      df.3 <- df.2
    }
  } else {
    df.3 <- df
  }
  list_all_4qc[[i]] <- df.3
}
names(list_all_4qc) <- xSite

save(list_all_4qc, file = here::here("working","All_4qc.RData"))




###################################################
FLYW$TempC <- as.numeric(FLYW$TempC)

dupFLYW <- FLYW[duplicated(FLYW$dts2),]
dupDECK <- DECK[duplicated(DECK$dts2),]

FLYW.2 <- FLYW[-duplicated(FLYW$dts2),]
DECK.2 <- DECK[-duplicated(DECK$dts2),]

FLYW.3 <- FLYW.2[-which(is.na(FLYW.2$dts2)==T),]
DECK.3 <- DECK.2[-which(is.na(DECK.2$dts2)==T | DECK.2$TempC < 0.9),]

DECK.3$Temp_Resto <- DECK.3$TempC

USGS_DECK.2$Temp_Ref <- USGS_DECK.2$tempC
USGS_DECK.2$dts2 <- USGS_DECK.2$dateTime

DECK_all <- merge(DECK.3[,c("dts2","Temp_Resto")], USGS_DECK.2[,c("dts2","Temp_Ref")])
DECK_all$diffTemp <- DECK_all$Temp_Resto - DECK_all$Temp_Ref

plo <- ggplot(DECK_all, aes(x = dts2, y = diffTemp)) +
  geom_point()

load(here::here("working","USGS_ToeDrain.RData"))
df_ToeDrain$Temp_Ref <- df_ToeDrain$tempC
df_ToeDrain$dts2 <- df_ToeDrain$dateTime

FLYW.3$Temp_Resto <- as.numeric(FLYW.3$TempC)

FLYW_all <- merge(FLYW.3[,c("dts2","Temp_Resto")], df_ToeDrain[,c("dts2","Temp_Ref")])
FLYW_all$diffTemp <- FLYW_all$Temp_Resto - FLYW_all$Temp_Ref

plo <- ggplot(FLYW_all, aes(x = dts2, y = diffTemp)) +
  geom_point()
```


Send to WaterVar_QC.Rmd


This is for hourly
```{r}

rm(list = ls())
load(here::here("working","QCd2_HourlyData.RData"))

list_DECK <- list_all_QC7$DECK
df_DECK <- rbind.data.frame(data.frame(dateTime = list_DECK$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_DECK$TempC$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_DECK$DOmgL$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$SPC$Datetime,
                                        variable = "sc",
                                        value = list_DECK$SPC$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$Turb$Datetime,
                                        variable = "turb",
                                        value = list_DECK$Turb$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$Depthm$Datetime,
                                        variable = "depth",
                                        value = list_DECK$Depthm$Var,
                                        Station = "DECK")
)

list_SACR <- list_all_QC7$SACR
df_SACR <- rbind.data.frame(data.frame(dateTime = list_SACR$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_SACR$TempC$Var,
                                        Station = "SACR"),
                             data.frame(dateTime = list_SACR$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_SACR$DOmgL$Var,
                                        Station = "SACR"),
                             data.frame(dateTime = list_SACR$SPC$Datetime,
                                        variable = "sc",
                                        value = list_SACR$SPC$Var,
                                        Station = "SACR"),
                             data.frame(dateTime = list_SACR$Turb$Datetime,
                                        variable = "turb",
                                        value = list_SACR$Turb$Var,
                                        Station = "SACR"))

list_FLYW <- list_all_QC7$FLYW
df_FLYW <- rbind.data.frame(data.frame(dateTime = list_FLYW$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_FLYW$TempC$Var,
                                        Station = "FLYW"),
                             data.frame(dateTime = list_FLYW$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_FLYW$DOmgL$Var,
                                        Station = "FLYW"),
                             data.frame(dateTime = list_FLYW$SPC$Datetime,
                                        variable = "sc",
                                        value = list_FLYW$SPC$Var,
                                        Station = "FLYW"),
                             data.frame(dateTime = list_FLYW$Turb$Datetime,
                                        variable = "turb",
                                        value = list_FLYW$Turb$Var,
                                        Station = "FLYW")
)

list_TOED <- list_all_QC7$TOED
df_TOED <- rbind.data.frame(data.frame(dateTime = list_TOED$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_TOED$TempC$Var,
                                        Station = "TOED"),
                             data.frame(dateTime = list_TOED$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_TOED$DOmgL$Var,
                                        Station = "TOED"),
                             data.frame(dateTime = list_TOED$SPC$Datetime,
                                        variable = "sc",
                                        value = list_TOED$SPC$Var,
                                        Station = "TOED"),
                             data.frame(dateTime = list_TOED$Turb$Datetime,
                                        variable = "turb",
                                        value = list_TOED$Turb$Var,
                                        Station = "TOED"))

df_DECK.2 <- reshape2::dcast(df_DECK, Station + dateTime ~ variable, value.var = "value")
df_SACR.2 <- reshape2::dcast(df_SACR, Station + dateTime ~ variable, value.var = "value")
df_FLYW.2 <- reshape2::dcast(df_FLYW, Station + dateTime ~ variable, value.var = "value")
df_TOED.2 <- reshape2::dcast(df_TOED, Station + dateTime ~ variable, value.var = "value")

df_DECK.m <- merge(df_DECK.2, df_SACR.2, by = "dateTime", all.x = TRUE, suffixes = c(".RESTO",".ADJ"))
df_FLYW.m <- merge(df_FLYW.2, df_TOED.2, by = "dateTime", all.x = TRUE, suffixes = c(".RESTO",".ADJ"))


df_DECK.m$diff_TempC <- as.numeric(df_DECK.m$TempC.RESTO) - as.numeric(df_DECK.m$TempC.ADJ)
df_FLYW.m$diff_TempC <- as.numeric(df_FLYW.m$TempC.RESTO) - as.numeric(df_FLYW.m$TempC.ADJ)

save(df_DECK.m, df_FLYW.m, file = here::here("working","MergedHourly_4Tide.RData"))
```


This is for quarter-hourly
```{r}

rm(list = ls())
load(here::here("working","QCd2_Data.RData"))

list_DECK <- list_all_QC7$DECK
df_DECK <- rbind.data.frame(data.frame(dateTime = list_DECK$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_DECK$TempC$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_DECK$DOmgL$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$SPC$Datetime,
                                        variable = "sc",
                                        value = list_DECK$SPC$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$Turb$Datetime,
                                        variable = "turb",
                                        value = list_DECK$Turb$Var,
                                        Station = "DECK"),
                             data.frame(dateTime = list_DECK$Depthm$Datetime,
                                        variable = "depth",
                                        value = as.numeric(list_DECK$Depthm$Var),
                                        Station = "DECK")
)

list_SACR <- list_all_QC7$SACR
df_SACR <- rbind.data.frame(data.frame(dateTime = list_SACR$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_SACR$TempC$Var,
                                        Station = "SACR"),
                             data.frame(dateTime = list_SACR$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_SACR$DOmgL$Var,
                                        Station = "SACR"),
                             data.frame(dateTime = list_SACR$SPC$Datetime,
                                        variable = "sc",
                                        value = list_SACR$SPC$Var,
                                        Station = "SACR"),
                             data.frame(dateTime = list_SACR$Turb$Datetime,
                                        variable = "turb",
                                        value = list_SACR$Turb$Var,
                                        Station = "SACR"))

list_FLYW <- list_all_QC7$FLYW
df_FLYW <- rbind.data.frame(data.frame(dateTime = list_FLYW$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_FLYW$TempC$Var,
                                        Station = "FLYW"),
                             data.frame(dateTime = list_FLYW$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_FLYW$DOmgL$Var,
                                        Station = "FLYW"),
                             data.frame(dateTime = list_FLYW$SPC$Datetime,
                                        variable = "sc",
                                        value = list_FLYW$SPC$Var,
                                        Station = "FLYW"),
                             data.frame(dateTime = list_FLYW$Turb$Datetime,
                                        variable = "turb",
                                        value = list_FLYW$Turb$Var,
                                        Station = "FLYW")
)

list_TOED <- list_all_QC7$TOED
df_TOED <- rbind.data.frame(data.frame(dateTime = list_TOED$TempC$Datetime,
                                        variable = "TempC",
                                        value = list_TOED$TempC$Var,
                                        Station = "TOED"),
                             data.frame(dateTime = list_TOED$DOmgL$Datetime,
                                        variable = "do",
                                        value = list_TOED$DOmgL$Var,
                                        Station = "TOED"),
                             data.frame(dateTime = list_TOED$SPC$Datetime,
                                        variable = "sc",
                                        value = list_TOED$SPC$Var,
                                        Station = "TOED"),
                             data.frame(dateTime = list_TOED$Turb$Datetime,
                                        variable = "turb",
                                        value = list_TOED$Turb$Var,
                                        Station = "TOED"))

df_DECK.2 <- reshape2::dcast(df_DECK, Station + dateTime ~ variable, value.var = "value")
df_SACR.2 <- reshape2::dcast(df_SACR, Station + dateTime ~ variable, value.var = "value")
df_FLYW.2 <- reshape2::dcast(df_FLYW, Station + dateTime ~ variable, value.var = "value")
df_TOED.2 <- reshape2::dcast(df_TOED, Station + dateTime ~ variable, value.var = "value")

df_DECK.m <- merge(df_DECK.2, df_SACR.2, by = "dateTime", all.x = TRUE, suffixes = c(".RESTO",".ADJ"))
df_FLYW.m <- merge(df_FLYW.2, df_TOED.2, by = "dateTime", all.x = TRUE, suffixes = c(".RESTO",".ADJ"))


df_DECK.m$diff_TempC <- as.numeric(df_DECK.m$TempC.RESTO) - as.numeric(df_DECK.m$TempC.ADJ)
df_FLYW.m$diff_TempC <- as.numeric(df_FLYW.m$TempC.RESTO) - as.numeric(df_FLYW.m$TempC.ADJ)

save(df_DECK.m, df_FLYW.m, file = here::here("working","Merged_4Tide.RData"))
```

