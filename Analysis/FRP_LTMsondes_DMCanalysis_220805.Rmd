---
title: "FRP_LTMsonde analysis"
author: "DMC"
date: "5/25/2022"
output: html_document
---


This file contains a preliminary view of the long-term sonde deployments for Yolo Flyway Farms and Decker (breach + pool)
OLD - DMC210722 - this was modified to include the new compiled data perfomed by DMC on 210722
DMC220526 - this was modified to work with the new compiled data performed by DMC on 220525

```{r}
rm(list = ls())

df_DeckB <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_DeckerBreach.csv"))
df_DeckB$Site.Name <- c("Decker Breach")
df_DeckP <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_DeckerPool.csv"))
df_DeckP$Site.Name <- c("Decker Pool")
df_YoloF <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_YoloFlyway.csv"))
df_YoloF$Site.Name <- c("Yolo Flyway Farm")
df <- rbind.data.frame(df_DeckB,df_DeckP,df_YoloF)
colnames(df) <- c("SondeName","Date","Time","tFracSec","Site","ChlRFU","Depthm","fDOMRFU","DOsat","DOmgL","SPC","PCRFU","Turb","TempC","WiperPos")
df$dts <- paste(df$Date,df$Time,sep = " ")
df$dts <- as.POSIXct(strptime(df$dts, format = "%m/%d/%Y %H:%M:%S"))
df$Chlconc <- c(rep(NA,length(df$SondeName)))
df$fDOMconc <- c(rep(NA,length(df$SondeName)))

save(df, file = "FRP_LTMsonde_220526.RData") ###DMC220714: saved again to include Decker Breach data from 210414-210707
```

This chunk will replicate the work by Mandy (again). For Decker
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

df <- df[which(df$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]
df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("SacSherman_CDEC","M13_USGS") & # "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU")]
dat[,10:11] <- as.numeric(NA)
colnames(dat)[10:11] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:11] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,11,8,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)

dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")


dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','fDOMRFU','fdomConc','PCRFU'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU),
               #Chlconcbar = mean(Chlconc),
               fDOMRFUbar = mean(fDOMRFU),
               fDOMconcbar = mean(fdomConc),
               PCbar = mean(PCRFU)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Decker Breach", "Decker Pool", "SacSherman_CDEC", "M13_USGS"))#,, "SDI_USGS", "Emmaton_CDEC"
                                  #labels = c("P","B","S","Y","T"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]

to_plo_sub$ord <- as.numeric(to_plo_sub$Station.Code)
to_plo_sub <- to_plo_sub[order(to_plo_sub$ord),]

unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","Toe Drain")
decker <- c("Decker Breach","Decker Pool","M13_USGS") # ,"SacSherman_CDEC" has info #,"SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Pool" | to_plo_sub$Station.Code == "Decker Breach")]
xdtsDeck2 <- range(xdtsDeck)

mycol <- (viridis_pal(option = "H")(56))[c(24,44,33)]
mycol[3] <- c("black")
mysh <- c(25,21,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)


plo_agg_subT <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp %in% xdtsDeck & to_plo_sub$variable == "Tempbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_point(colour = "black") +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


plo_agg_subDO <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "DObar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code,shape = Station.Code, size = Station.Code)) +
  geom_point(colour = "black") +
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


mycol
to_plo_sub2 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "M13_USGS"),], #"SacSherman_CDEC"
                                to_plo_sub[which(to_plo_sub$Station.Code == "Decker Breach"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "Decker Pool"),])
plo_agg_subSPC <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% decker & (to_plo_sub2$datetimestamp >= xdtsDeck2[1] & to_plo_sub2$datetimestamp <= xdtsDeck2[2]) & to_plo_sub2$variable == "SPCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_point(color = "#36454F") + #colour = "black"
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Specific Conductivity (\u00B5S/cm)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subSPC + annotation_custom(grob = ggplotGrob(plo_agg_subSPC +ylim(0,2100) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2020-01-05",format = "%Y-%m-%d")),
                                         ymin = 375, ymax = 675)


###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
plo_agg_subTu <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% decker & (to_plo_sub2$datetimestamp >= xdtsDeck2[1] & to_plo_sub2$datetimestamp <= xdtsDeck2[2]) & to_plo_sub2$variable == "Turbbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(colour = "black") +
  geom_hline(yintercept=12, linetype = "dashed")+ #Grimaldo LF, Sommer T, Van Ark N, Jones G, Holland E, Moyle PB, Smith P, Herbold B. 2009a. Factors affecting fish entrainment into massive water diversions in a freshwater tidal estuary: Can fish losses be managed? N Am J Fish Manage 29:1253-1270.
  geom_hline(yintercept=80) + # Can also use this for the above '12' turbidity value too: Hasenbein M, Fangue NA, Geist J, Komoroske LM, Truong J, McPherson R, Connon RE (2016) Assessments at multiple levels of biological organization allow for an integrative determination of physiological tolerances to turbidity in an endangered fish species. Conserv Physiol 4: doi:10.1093/conphys/cow004.
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = c(myalf[1:2],0.4),labels = c("Breach","Interior","Sacramento\nRiver")) +
  #ylim(0,400)+
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

pl2 <- plo_agg_subTu + annotation_custom(grob = ggplotGrob(plo_agg_subTu +ylim(0,125) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-07-07",format = "%Y-%m-%d")),
                                         ymin = 225, ymax = 425)


deckerOnly <- decker[1:2]
plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & to_plo_sub$variable == "ChlRFUbar" & to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior")) +
  theme_classic() +
  ylim(0,2) +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subChl + annotation_custom(grob = ggplotGrob(plo_agg_subChl + ylim(0,45) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-08-10",format = "%Y-%m-%d")),
                                         ymin = 1.2, ymax =2.1)

sac <- decker[3]
plo_agg_subChlsac <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% sac & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[3],labels = c("Sac.\nRiver   "))+ 
  scale_shape_manual(values = mysh[3],labels = c("Sac.\nRiver   ")) +
  scale_size_manual(values = myps[3],labels = c("Sac.\nRiver   ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (\u00B5g/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
gridExtra::grid.arrange(arrangeGrob(pl2, plo_agg_subChlsac,nrow = 2), ncol =1)

pl2sac <- plo_agg_subChlsac + annotation_custom(grob = ggplotGrob(plo_agg_subChlsac +ylim(0,10) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-08-10",format = "%Y-%m-%d")),
                                         ymin = 50, ymax = 130)
gridExtra::grid.arrange(arrangeGrob(pl2, pl2sac,nrow = 2), ncol =1)


plo_agg_subChlBoth <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(data = to_plo_sub[which(to_plo_sub$Station.Code %in% sac & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value-1), fill = mycol[3], shape = mysh[3], size = myps[3]) +
  geom_point(colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior")) +
  scale_y_continuous(sec.axis = sec_axis(~.-1, name = "Chlorophyll a (\u00B5g/L)"))+
  theme_classic() +
  ylim(0,5) +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subChl + annotation_custom(grob = ggplotGrob(plo_agg_subChl +ylim(0,175) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2020-01-10",format = "%Y-%m-%d")),
                                         ymin = 1.5, ymax = 5.2)



deckerOnly <- decker[1:2]
plo_agg_subPC <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "PCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  theme_classic() +
  xlab("Date") +
  ylab("Phycocyanin (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subPC + annotation_custom(grob = ggplotGrob(plo_agg_subPC +ylim(0,5) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-07-25",format = "%Y-%m-%d")),
                                         ymin = 25, ymax = 50)

deckerOnly <- decker[1:2]
plo_agg_subfdom <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "fDOMRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  theme_classic() +
  #ylim(0,5) +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


sac <- decker[3]
plo_agg_subfdomsac <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% sac & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "fDOMconcbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  xlim(xdtsDeck2) +
  scale_fill_manual(values = mycol[3],labels = c("Sac.\nRiver   "))+ 
  scale_shape_manual(values = mysh[3],labels = c("Sac.\nRiver   ")) +
  scale_size_manual(values = myps[3],labels = c("Sac.\nRiver   ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (mg/L as QSE)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


gridExtra::grid.arrange(arrangeGrob(plo_agg_subfdom, plo_agg_subfdomsac,nrow = 2), ncol =1)

sites <- c(yolo, decker)
p <- list()
for(i in seq_along(sites)){
  df <- agg_dat_subD[which(agg_dat_subD$Station.Code == sites[i]),]
  dfT95 <- aggregate(TempC ~ datetimestamp, data = df, FUN = quantile, probs  = 0.95)
  dfT95$qua <- c("pct95")
  dfT95$lt <- c("dotted")
  dfT50 <- aggregate(TempC ~ datetimestamp, data = df, FUN = quantile, probs  = 0.50)
  dfT50$qua <- c("median")
  dfT50$lt <- c("solid")
  dfT05 <- aggregate(TempC ~ datetimestamp, data = df, FUN = quantile, probs  = 0.05)
  dfT05$qua <- c("pct5")
  dfT05$lt <- c("dashed")
  dfD95 <- aggregate(DOmgL ~ datetimestamp, data = df, FUN = quantile, probs  = 0.95)
  dfD95$qua <- c("pct95")
  dfD95$lt <- c("dotted")
  dfD50 <- aggregate(DOmgL ~ datetimestamp, data = df, FUN = quantile, probs  = 0.50)
  dfD50$qua <- c("median")
  dfD50$lt <- c("solid")
  dfD05 <- aggregate(DOmgL ~ datetimestamp, data = df, FUN = quantile, probs  = 0.05)
  dfD05$qua <- c("pct5")
  dfD05$lt <- c("dashed")
  dfTu95 <- aggregate(Turb ~ datetimestamp, data = df, FUN = quantile, probs  = 0.95)
  dfTu95$qua <- c("pct95")
  dfTu95$lt <- c("dotted")
  dfTu50 <- aggregate(Turb ~ datetimestamp, data = df, FUN = quantile, probs  = 0.50)
  dfTu50$qua <- c("median")
  dfTu50$lt <- c("solid")
  dfTu05 <- aggregate(Turb ~ datetimestamp, data = df, FUN = quantile, probs  = 0.05)
  dfTu05$qua <- c("pct5")
  dfTu05$lt <- c("dashed")
  dfT <- rbind.data.frame(dfT95,dfT50,dfT05)
  dfT$variable <- "TempC"
  colnames(dfT)[2] <- c("value")
  dfT$Site <- sites[i]
  dfD <- rbind.data.frame(dfD95,dfD50,dfD05)
  dfD$variable <- "DOmgL"
  dfD$Site <- sites[i]
  colnames(dfD)[2] <- c("value")
  dfTu <- rbind.data.frame(dfTu95,dfTu50,dfTu05)
  dfTu$variable <- "Turb"
  colnames(dfTu)[2] <- c("value")
  dfTu$Site <- sites[i]
  p[[i]] <- rbind.data.frame(dfT,dfD,dfTu)
}
names(p) <- sites
to_plo2 <- do.call(rbind.data.frame, p)

xdtsDeck2 <- to_plo2$datetimestamp[which(to_plo2$Site == "Decker Breach")]
xdtsYolo2 <- to_plo2$datetimestamp[which(to_plo2$Site == "Yolo Flyway Farm")]

plo_stat <- ggplot(to_plo2[which(to_plo2$Site %in% yolo & to_plo2$datetimestamp %in% xdtsYolo2),], aes(x = datetimestamp, y = value, colour = Site, linetype = lt)) +
  geom_line() +
  facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() 



to_plo3 <- dcast(to_plo2,datetimestamp+Site+variable ~qua)
to_plo3$variable <- factor(to_plo3$variable, levels = c("TempC","DOmgL","Turb"), labels = c("Temperature (C)","Dissolved Oxygen (mg/L)","Turbidity (FNU)"))
plo_stat2 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  theme(axis.title.y = element_blank())

plo_stat2 <- ggplot(to_plo3[which(to_plo3$Site %in% yolo & to_plo3$datetimestamp %in% xdtsYolo2),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  theme(axis.title.y = element_blank())


### Feb21 to Mar16 had no sondes
skipS <- c(as.POSIXct(strptime(c('2020-02-21 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-12 04:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-21 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-12 04:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-21 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-12 04:00:00'),format = "%Y-%m-%d %H:%M")))
skipE <- c(as.POSIXct(strptime(c('2020-03-18 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-13 16:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-03-18 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-13 16:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-03-18 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-13 16:00:00'),format = "%Y-%m-%d %H:%M")))
valmax <- c(23,23,12,12,400,400)#max(to_plo3$pct95[which(to_plo3$variable== "Temperature (C)")])
valmin <- c(5,5,5,5,0,0)#min(to_plo3$pct5[which(to_plo3$variable== "Temperature (C)")])
varSkip <- c("temp","temp","do","do","turb","turb")
dfBox <- data.frame(skipS,skipE,valmax,valmin, varSkip)

plo_stat4 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2 & to_plo3$variable=="Temperature (C)"),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  geom_hline(yintercept=25.4) + 
  geom_hline(yintercept=24, linetype="dashed") + 
  geom_rect(data = dfBox[which(dfBox$varSkip == "temp"),], aes(xmin = skipS, xmax = skipE, ymin = valmin, ymax = valmax),color = "white",fill="white")+
  scale_color_manual(values = mycol,labels = c("Pool","Breach","Channel")) +
  #scale_shape_manual(values = mysh,labels = c("Pool","Breach","Channel")) +
  #facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (C)") +
  #theme(axis.text.x =element_blank())+
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_stat5 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2 & to_plo3$variable=="Dissolved Oxygen (mg/L)"),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  geom_hline(yintercept=2.5) + 
  geom_hline(yintercept=4.6, linetype="dashed") + 
  geom_rect(data = dfBox[which(dfBox$varSkip == "do"),], aes(xmin = skipS, xmax = skipE, ymin = valmin, ymax = valmax),color = "white",fill="white")+
  scale_color_manual(values = mycol,labels = c("Pool","Breach","Channel")) +
  scale_shape_manual(values = mysh,labels = c("Pool","Breach","Channel")) +
  #facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  #theme(axis.text.x =element_blank())+
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_stat6 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2 & to_plo3$variable=="Turbidity (FNU)"),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  geom_rect(data = dfBox[which(dfBox$varSkip == "turb"),], aes(xmin = skipS, xmax = skipE, ymin = valmin, ymax = valmax),color = "white",fill="white")+
  geom_hline(yintercept=12)+
  geom_hline(yintercept=80) + 
  scale_color_manual(values = mycol,labels = c("Pool","Breach","Channel")) +
  scale_shape_manual(values = mysh,labels = c("Pool","Breach","Channel")) +
  #facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  #theme(axis.text.x =element_blank())+
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

```


For Yolo
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

df <- df[which(df$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("TOE_USGS","LIB_USGS") & 
                       dfAll$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU")]
dat[,10:11] <- as.numeric(NA)
colnames(dat)[10:11] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:11] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,11,8,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)
dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")




dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','fDOMRFU','fdomConc','PCRFU'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU),
               #Chlconcbar = mean(Chlconc),
               fDOMRFUbar = mean(fDOMRFU),
               fDOMconcbar = mean(fdomConc),
               PCbar = mean(PCRFU)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Yolo Flyway Farm","TOE_USGS","LIB_USGS"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]


unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","TOE_USGS","LIB_USGS")
decker <- c("Decker Breach","Decker Pool","SDI_USGS")

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Breach")]
xdtsYolo <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Yolo Flyway Farm")]
xdtsYolo2 <- range(xdtsYolo)


mycol <- (viridis_pal(option = "H")(56))[c(44,24,33)]
mycol[3] <- c("black")
mysh <- c(21,25,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)


to_plo_sub2 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "Yolo Flyway Farm"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "TOE_USGS"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "LIB_USGS"),])

plo_agg_subT <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "Tempbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

### shape for breach is 4, shape for pool is 24, use circle 20 for channel

plo_agg_subDO <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "DObar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subSPC <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "SPCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Specific Conductivity (\u00B5S/cm)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


plo_agg_subTu <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "Turbbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=12, linetype = "dashed")+
  geom_hline(yintercept=80) +
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

pl2 <- plo_agg_subTu + annotation_custom(grob = ggplotGrob(plo_agg_subTu +ylim(0,100) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-05-15",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2021-11-30",format = "%Y-%m-%d")), 
                                         ymin = 175, ymax = 400)


plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yolo & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol,labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh,labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps,labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

yoloOnly <- yolo[1]
plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp >= xdtsYolo2[1] & to_plo_sub$datetimestamp <= xdtsYolo2[2] & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1],labels = c("Flyway"))+ 
  scale_shape_manual(values = mysh[1],labels = c("Flyway")) +
  scale_size_manual(values = myps[1],labels = c("Flyway")) +
  ylim(0,15) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <-plo_agg_subChl + annotation_custom(grob = ggplotGrob(plo_agg_subChl +ylim(0,42) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-03-07",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2022-01-10",format = "%Y-%m-%d")), 
                                         ymin = 8, ymax = 15)


toed <- yolo[2:3]
plo_agg_subChlToe <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% toed & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[2:3],labels = c("Toe Drain","Liberty"))+ 
  scale_shape_manual(values = mysh[2:3],labels = c("Toe Drain","Liberty")) +
  scale_size_manual(values = myps[2:3],labels = c("Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (\u00B5g/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(pl2, plo_agg_subChlToe,nrow = 2), ncol =1)

yoloOnly <- yolo[1]
plo_agg_subPC <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp >= xdtsYolo2[1] & to_plo_sub$datetimestamp <= xdtsYolo2[2] & to_plo_sub$variable == "PCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1],labels = c("Flyway"))+ 
  scale_shape_manual(values = mysh[1],labels = c("Flyway")) +
  scale_size_manual(values = myps[1],labels = c("Flyway")) +
  ylim(0,3) +
  theme_classic() +
  xlab("Date") +
  ylab("Phycocyanin (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <-plo_agg_subPC + annotation_custom(grob = ggplotGrob(plo_agg_subPC  + ylim(0,42) +
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-03-07",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2022-01-10",format = "%Y-%m-%d")), 
                                         ymin = 2, ymax = 3)

yoloOnly <- yolo[1]
plo_agg_subfdom <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "fDOMRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1],labels = c("Flyway     "))+ 
  scale_shape_manual(values = mysh[1],labels = c("Flyway     ")) +
  scale_size_manual(values = myps[1],labels = c("Flyway     ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


toed <- yolo[2:3]
plo_agg_subfdomtoe <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% toed & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "fDOMconcbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[2:3],labels = c("Toe Drain","Liberty"))+ 
  scale_shape_manual(values = mysh[2:3],labels = c("Toe Drain","Liberty")) +
  scale_size_manual(values = myps[2:3],labels = c("Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (mg/L as QSE)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subfdom, plo_agg_subfdomtoe,nrow = 2), ncol =1)

```

For 2021 Tule Red data collected by DWR
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)

rm(list = ls())

dfTR <- data.frame(read.csv("TRB_2021_data.csv"))

unique(dfTR$qaqc_flag_id)
dfTR2 <- dfTR[which(dfTR$qaqc_flag_id == "G"),]
dfTR2$dts <- as.POSIXct(strptime(dfTR2$time, format = "%m/%d/%Y %H:%M"))
dfTR3 <- dfTR2[,c(6,5,2)]

dfTR4 <- reshape2::dcast(dfTR2, dts ~ analyte_name, value.var = "value")
colnames(dfTR4) <- c("dts","ChlRFU","DOmgL","pH","SPC","Turb","TempC")

dfTR4$Site <- "TuleRed"

xdtsTule <- range(dfTR4$dts)
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("Grizzly_USGS") & #,"Grizzly_CDEC", "GrizzlyL_CDEC" ###DMC: going to use only Grizzly_USGS
                       dfAll$dts >= as.POSIXct(strptime(xdtsTule[1], format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime(xdtsTule[2], format = "%Y-%m-%d"))),]

dat <- dfTR4[,c("Site","dts","TempC","SPC","pH","Turb","DOmgL","ChlRFU")]


#dfAll <- dfAll[,-5]
dfAll <- dfAll[,c("site","dts","temp","sc","ph","turb","do","chl")]
colnames(dfAll) <- colnames(dat)

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")




dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','pH','Turb','DOmgL','ChlRFU'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               pHbar = mean(pH),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU)
               #Chlconcbar = mean(Chlconc),
               #fDOMRFUbar = mean(fDOMRFU),
               #fDOMconcbar = mean(fdomConc),
               #PCbar = mean(PCRFU)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("TuleRed","Grizzly_USGS"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]


unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","TOE_USGS","LIB_USGS")
decker <- c("Decker Breach","Decker Pool","SDI_USGS")
tule <- c("TuleRed","Grizzly_USGS")

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Breach")]
xdtsYolo <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Yolo Flyway Farm")]
xdtsYolo2 <- range(xdtsYolo)


mycol <- (viridis_pal(option = "H")(56))[c(44,24,33)]
#mycol[3] <- c("black")
mysh <- c(21,25,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)


to_plo_sub2 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "TuleRed"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "Grizzly_USGS"),])



plo_agg_subT <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% tule & to_plo_sub2$variable == "Tempbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

### shape for breach is 4, shape for pool is 24, use circle 20 for channel

plo_agg_subDO <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% tule & to_plo_sub2$variable == "DObar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subPH <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% tule & to_plo_sub2$variable == "pHbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("pH") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

to_plo_sub3 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "Grizzly_USGS"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "TuleRed"),])
plo_agg_subSPC <- ggplot(to_plo_sub3[which(to_plo_sub3$Station.Code %in% tule & to_plo_sub3$variable == "SPCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Specific Conductivity (\u00B5S/cm)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


plo_agg_subTu <- ggplot(to_plo_sub3[which(to_plo_sub3$Station.Code %in% tule & to_plo_sub3$variable == "Turbbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=12, linetype = "dashed")+
  geom_hline(yintercept=80) +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yolo & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

tuleOnly <- tule[1]
plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% tuleOnly & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1], labels = c("Tule Red")) +
  scale_shape_manual(values = mysh[1], labels = c("Tule Red")) +
  scale_size_manual(values = myps[1], labels = c("Tule Red")) +
  scale_y_continuous(breaks = pretty_breaks(n = 5)) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())



griz <- tule[2]
plo_agg_subChlToe <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% griz & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[2], labels = c("Grizzly    ")) +
  scale_shape_manual(values = mysh[2], labels = c("Grizzly    ")) +
  scale_size_manual(values = myps[2], labels = c("Grizzly    ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (\u00B5g/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subChl, plo_agg_subChlToe,nrow = 2), ncol =1)

yoloOnly <- yolo[1]
plo_agg_subPC <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp >= xdtsYolo2[1] & to_plo_sub$datetimestamp <= xdtsYolo2[2] & to_plo_sub$variable == "PCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  ylim(0,3) +
  theme_classic() +
  xlab("Date") +
  ylab("Phycocyanin (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <-plo_agg_subPC + annotation_custom(grob = ggplotGrob(plo_agg_subPC  + ylim(0,42) +
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-03-07",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2022-01-10",format = "%Y-%m-%d")), 
                                         ymin = 2, ymax = 3)


```


