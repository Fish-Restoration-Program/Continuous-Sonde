---
title: "FRP_2022_SiteReports_Phyto"
author: "DMC"
date: "6/23/2023"
output: html_document
---

The goal of this file is to make all data processing of raw EXO2 exports happen in R rather than a multitude of Excel files.


This chunk makes a dataframe with all the potential column names for CDFW FRP sondes so that we can replace them with simple versions
```{r}
df_VarNames <- data.frame(ExoVariable = c("Date..MM.DD.YYYY.", "Time..HH.mm.ss.", "Time..Fract..Sec.", "Site.Name", "Chlorophyll.RFU", "Cond.µS.cm", "Depth.m", "fDOM.QSU", "fDOM.RFU", "nLF.Cond.µS.cm", "ODO...sat", "ODO...CB", "ODO.mg.L", "Pressure.psi.a", "Sal.psu", "SpCond.µS.cm", "TAL.PC.RFU", "TDS.mg.L", "Turbidity.FNU", "TSS.mg.L", "Wiper.Position.volt", "Temp..C", "Vertical.Position.m", "Battery.V", "Cable.Pwr.V"),
                          VarName = c("Date", "Time", "tFracSec", "Site", "ChlRFU","Cond", "Depthm", "fDOMQSU", "fDOMRFU", "nCond", "DOsat", "DOcb", "DOmgL", "PressurePSI", "SalPSU", "SPC", "PCRFU", "TDSmgL", "Turb", "TSSmgL", "WiperPos", "TempC", "VertPositionm", "Battery", "CablePwr"),
                          PortalName = c("Date","Time",NA,"Site","Chl",NA,"Depth",NA,"fDOM",NA,"DOsat",NA,"DOconc",NA,NA,"SPC","PC",NA,"Turb",NA,NA,"TempC",NA,"Battery",NA))#,
                          #keepTorF = c(T,T,F,T,T,F,T,F,T,F,T,F,T,F,F,T,T,F,T,F,T,T,F,T,F))

save(df_VarNames, file = "working/CDFW_VarNamesConversion.RData")
```


First we are going to import 1 file into 2 pieces. The first piece will include the sonde metadata and the second piece will contain the continuous data.
```{r}
rm(list = ls())

rawmeta <- data.frame(head(read.csv(here::here("raw","DECK","DeckerPool_211130to220127.csv"),skip = 6, fileEncoding = "utf-16")))
meta_1 <- data.frame(data.table::transpose(rawmeta))
meta_2 <- meta_1[-c(1:3),c(2,1,3)]
colnames(meta_2) <- c("ExoVariable","ExoValue","ToRemove")
meta_2$ExoValue[which(meta_2$ExoVariable == "Site Name")] <- meta_2$ToRemove[which(meta_2$ExoVariable == "Site Name")]
meta_3 <- meta_2[,c("ExoVariable","ExoValue")]
meta_3[nrow(meta_3)+1,] <- c("Sonde",meta_3$ExoValue[which(meta_3$ExoVariable == "Battery V")])

rawdf <- data.frame(read.csv(here::here("raw","DECK","DeckerPool_211130to220127.csv"),skip = 9, fileEncoding = "utf-16", header = T))

### 
# Now we will change the names of the columns using the conversion developed previously
load(here::here("working","CDFW_VarNamesConversion.RData"))
# use a for loop to change the column name
for(i in 1:length(colnames(rawdf))){
  for(j in 1:nrow(df_VarNames)){
    if(colnames(rawdf)[i] == df_VarNames$ExoVariable[j]){
      colnames(rawdf)[i] = df_VarNames$VarName[j]
    }
  }
}

```

