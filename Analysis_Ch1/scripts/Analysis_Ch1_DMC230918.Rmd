---
title: "Analyses for Ch1 of Big Report"
author: "DMC"
date: "2023-09-18"
---

Here is the final script to the analyses for Chapter 1.

```{r import FRP data}
rm(list = ls())
load(here::here("imports", "QCd_Data_FRP.RData"))

# create a new list of qc'd data frames to be filtered by year
list_all <- list_all_qc

for(i in 1:length(list_all_qc)){
  #list_2022 <- list() # temporary list
  for(j in 1:length(list_all_qc[[i]])){
    
    rtd_sondeID <- strsplit(names(list_all_qc[[i]])[j], split = " ", fixed = TRUE)[[1]][1] # variable for sondeID
    rtd_dateDeploy <- as.numeric(substr(strsplit(names(list_all_qc[[i]])[j], split = " ", fixed = TRUE)[[1]][2],0,4)) # variable for Deployment date
    rtd_dateRecov <- as.numeric(substr(strsplit(names(list_all_qc[[i]])[j], split = " ", fixed = TRUE)[[1]][3],0,4)) # variable for Recovery date                              0)
    if((rtd_dateDeploy >= 2023 & rtd_dateRecov >= 2023)){
      list_all[[i]][[j]] <- list(NULL)
    } else {
      skip_to_next <- FALSE
      tryCatch({
      list_all[[i]][[j]] <- list_all_qc[[i]][[j]][,c("Site","dts","TempC","SPC","DOmgL","Turb","TempC_qcE","SPC_qcE","DOmgL_qcE","Turb_qcE")]
      },
      error = function(e){ skip_to_next <<- TRUE})
      if(skip_to_next) {next}
    }
    rm(rtd_sondeID, rtd_dateDeploy, rtd_dateRecov)
  # when an error is encountered, the loop will be forced to continue and the warning(s) will be shown at the end
  }
}



FLYW <- do.call(rbind.data.frame, list_all[[1]])
FLYW$dts2 <- lubridate::floor_date(FLYW$dts, "15 minutes")
DECK_pool <- do.call(rbind.data.frame, list_all[[2]])
DECK_pool$dts2 <- lubridate::floor_date(DECK_pool$dts, "15 minutes")
DECK_breach <- do.call(rbind.data.frame, list_all[[3]])
DECK_breach$dts2 <- lubridate::floor_date(DECK_breach$dts, "15 minutes")

save(DECK_breach, DECK_pool, FLYW, file = here::here("working","ImportedRaw.RData"))
```


```{r get 1 file for DECK}
library(ggplot2)

rm(list = ls())

load(here::here("working","ImportedRaw.RData"))
'%ni%' = Negate('%in%')

DECK_breach.2 <- DECK_breach[which(DECK_breach$dts2 %ni% DECK_pool$dts2),]
DECK_pool$TempC <- as.numeric(DECK_pool$TempC)
DECK_breach.2$TempC <- as.numeric(DECK_breach.2$TempC)

plo <- ggplot(DECK_pool, aes(x = dts2, y = TempC)) +
  geom_point(color = "black", alpha = 0.2) +
  geom_point(data = DECK_breach.2, aes(x = dts2, y = TempC), color = "red", alpha = 0.2)

DECK <- rbind.data.frame(DECK_pool, DECK_breach.2)

save(DECK, FLYW, file = here::here("working","FRP_Raw.RData"))
```

For data from USGS Toland station near Decker Island
```{r}
library(tidyverse)
library(dataRetrieval)
rm(list = ls())

siteNumber <- "11455485"
parameterCd <- "00065" # Discharge
startDate <- "2019-01-01T00:00"
endDate <- "2022-12-31T23:45"
timezone <- "America/Los_Angeles"

parameterQ <- read.csv(here::here("imports","ExtPrograms","USGS","USGS_parameters.csv"))

dailyDataAvailable <- whatNWISdata(
 siteNumber = siteNumber,
 service = "iv"
)
dailyDataAvailable$parameter <- NA
dailyDataAvailable2 <- merge(dailyDataAvailable, parameterQ[,c(1,3)], by = "parm_cd")
siteINFO <- readNWISsite(siteNumber)
siteAll <- readNWISdata(sites = siteNumber, service = "iv", startDate = startDate, endDate = endDate,tz = timezone)

#save(siteAll, file = here::here("working", "USGS_11455485.RData"))

#load(here::here("working", "USGS_11455485.RData"))

col2get <- data.frame(colnames(siteAll),NA)
col2get[,2] <- stringr::str_match(col2get[,1], "_\\d+")
col2get$parm_cd <- substr(col2get[,2],2,nchar(col2get[,2]))
colnames(col2get) <- c("colsNames","num1","parm_cd")
col2get2 <- merge(col2get,parameterQ[,c(1,3)],by = "parm_cd")

df_Toland <- siteAll[,c(2,3,14,15, # 14 and 15 are DO and its QC status
                        which(colnames(siteAll) %in% col2get2[c(3,4, #temperature of upper sonde and its QC status
                                                                    8,9,# SC of upper sonde and its QC status
                                                                    13,14,# fdom of upper sonde and its QC status
                                                                    15,16,# chl of upper sonde and its QC status
                                                                    17,20) # turb of upper sonde and its QC status
                                                                  ,"colsNames"] 
                                  ))] 

colnames(df_Toland)[3:14] <- c("do","do_flag","tempC","tempC_flag","sc","sc_flag","fdom","fdom_flag","chl","chl_flag","turb","turb_flag")

save(df_Toland, file = here::here("working", "ExtPrograms", "USGS_Toland.RData"))
```

For 2022 data from USGS Toe Drain station near Yolo Flyway Farms
```{r}
library(tidyverse)
library(dataRetrieval)
rm(list = ls())

siteNumber <- "11455140"
parameterCd <- "00065" # Discharge
startDate <- "2019-01-01T00:00"
endDate <- "2022-12-31T23:45"
timezone <- "America/Los_Angeles"

parameterQ <- read.csv(here::here("raw","ExtPrograms","USGS","USGS_parameters.csv"))

dailyDataAvailable <- whatNWISdata(
 siteNumber = siteNumber,
 service = "iv"
)
dailyDataAvailable$parameter <- NA
dailyDataAvailable2 <- merge(dailyDataAvailable, parameterQ[,c(1,3)], by = "parm_cd")
siteINFO <- readNWISsite(siteNumber)
siteAll <- readNWISdata(sites = siteNumber, service = "iv", startDate = startDate, endDate = endDate,tz = timezone)

#save(siteAll, file = here::here("working", "USGS_11455485.RData"))

#load(here::here("working", "USGS_11455485.RData"))

col2get <- data.frame(colnames(siteAll),NA)
col2get[,2] <- stringr::str_match(col2get[,1], "_\\d+")
col2get$parm_cd <- substr(col2get[,2],2,nchar(col2get[,2]))
colnames(col2get) <- c("colsNames","num1","parm_cd")
col2get2 <- merge(col2get,parameterQ[,c(1,3)],by = "parm_cd")

df_ToeDrain <- siteAll[,c(2,3,12,13, # 12 and 13 are DO and its QC status
                          which(colnames(siteAll) %in% col2get2[c(1,2, #temperature of upper sonde and its QC status
                                                                    7,8,# SC of upper sonde and its QC status
                                                                    13,14,# fdom of upper sonde and its QC status
                                                                    15,16,# chl of upper sonde and its QC status
                                                                    17,18,# turb of upper sonde and its QC status
                                                                    9,10,# pH and its QC status
                                                                    5,6) # gage height and its QC status
                                                                  ,"colsNames"] 
                                  ))] 

colnames(df_ToeDrain)[3:18] <- c("do","do_flag","tempC","tempC_flag","gage","gage_flag","sc","sc_flag", "pH","pH_flag","fdom","fdom_flag","chl","chl_flag","turb","turb_flag")

save(df_ToeDrain, file = here::here("working", "ExtPrograms", "USGS_ToeDrain.RData"))
```
