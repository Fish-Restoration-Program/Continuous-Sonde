---
title: "FRP_LTMsonde analysis"
author: "DMC"
date: "5/25/2022"
output: html_document
---


This file contains a preliminary view of the long-term sonde deployments for Yolo Flyway Farms and Decker (breach + pool)
OLD - DMC210722 - this was modified to include the new compiled data perfomed by DMC on 210722
DMC220526 - this was modified to work with the new compiled data performed by DMC on 220525

```{r}
rm(list = ls())

df_DeckB <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_DeckerBreach.csv"))
df_DeckB$Site.Name <- c("Decker Breach")
df_DeckP <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_DeckerPool.csv"))
df_DeckP$Site.Name <- c("Decker Pool")
df_YoloF <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_YoloFlyway.csv"))
df_YoloF$Site.Name <- c("Yolo Flyway Farm")
df <- rbind.data.frame(df_DeckB,df_DeckP,df_YoloF)
colnames(df) <- c("SondeName","Date","Time","tFracSec","Site","ChlRFU","Depthm","fDOMRFU","DOsat","DOmgL","SPC","PCRFU","Turb","TempC","WiperPos")
df$dts <- paste(df$Date,df$Time,sep = " ")
df$dts <- as.POSIXct(strptime(df$dts, format = "%m/%d/%Y %H:%M:%S"))
df$Chlconc <- c(rep(NA,length(df$SondeName)))
df$fDOMconc <- c(rep(NA,length(df$SondeName)))

save(df, file = "FRP_LTMsonde_221207.RData") ###DMC220714: saved again to include Decker Breach data from 210414-210707
```

For Tule Red data collected by ESA (2020, 2022) and DWR (2021)
```{r}
library(ggplot2)

rm(list = ls())

df_TuleESA_B <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_ESA_TULEbreach.csv"))
df_TuleESA_B.2 <- df_TuleESA_B[-which(df_TuleESA_B$datetimestamp == ""),]
df_TuleESA_B.2$Site <- "Tule Breach"
df_TuleESA_P <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_ESA_TULEpond.csv"))
df_TuleESA_P.2 <- df_TuleESA_P[-which(df_TuleESA_P$datetimestamp == ""),] 
df_TuleESA_P.2$Site <- "Tule Pond"
df_TuleESA_P.2[,c("Pressure_psi","Depth_ft")] <- NA
df_TuleESA_Ch <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_ESA_TULEchannel.csv"))
df_TuleESA_Ch$Site <- "Tule Channel"
df_TuleESA_Ch[,c("Baro_psi","Pressure_psi","Depth_ft","Chla_RFU","Chla_ugL","SPC","Saln_psu","Turb_NTU")] <- NA


df_TuleESA <- rbind.data.frame(df_TuleESA_B.2[,c("Site","datetimestamp","Depth_ft","TempC","DO_mgL","SPC","Saln_psu","Turb_NTU","Chla_RFU","Chla_ugL","Baro_psi","Pressure_psi")],
                            df_TuleESA_P.2[,c("Site","datetimestamp","Depth_ft","TempC","DO_mgL","SPC","Saln_psu","Turb_NTU","Chla_RFU","Chla_ugL","Baro_psi","Pressure_psi")],
                            df_TuleESA_Ch[,c("Site","datetimestamp","Depth_ft","TempC","DO_mgL","SPC","Saln_psu","Turb_NTU","Chla_RFU","Chla_ugL","Baro_psi","Pressure_psi")])

df_TuleESA$datetimestamp <- gsub("3/16/22","3/16/2022", df_TuleESA$datetimestamp,fixed = TRUE)
df_TuleESA$dts <- as.POSIXct(strptime(df_TuleESA$datetimestamp, format = "%m/%d/%Y %H:%M"))

df_TuleESA.2 <- df_TuleESA[,c("Site","dts","Depth_ft","TempC","DO_mgL","SPC","Saln_psu","Turb_NTU","Chla_RFU","Chla_ugL","Baro_psi","Pressure_psi")]
ggplot(df_TuleESA.2, aes(x = dts, y = TempC)) + geom_point(alpha = 0.5) + facet_grid(Site~.)

### now add Tule Red data from DWR breach by MWQI
df_TuleMWQI_B <- data.frame(read.csv("TRB_2021_MWQIdata.csv"))

unique(df_TuleMWQI_B$qaqc_flag_id)
df_TuleMWQI_B.2 <- df_TuleMWQI_B[which(df_TuleMWQI_B$qaqc_flag_id == "G"),]
df_TuleMWQI_B.2$dts <- as.POSIXct(strptime(df_TuleMWQI_B.2$time, format = "%m/%d/%Y %H:%M"))


df_TuleMWQI_B.3 <- df_TuleMWQI_B.2[which(df_TuleMWQI_B.2$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       df_TuleMWQI_B.2$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),
               c(6,5,2)]


df_TuleMWQI <- reshape2::dcast(df_TuleMWQI_B.2, dts ~ analyte_name, value.var = "value")


### now add Tule Red data from FRP-DWR
df_TuleDWR_B <- data.frame(read.csv("DMC_CompileDataRaw4R_FRPDWR_TULEbreach.csv"))
df_TuleDWR_P <- data.frame(read.csv("DMC_CompileDataRaw4R_FRPDWR_TULEpond.csv"))
df_TuleDWR_B[,colnames(df_TuleDWR_P)[16:19]] <- NA
df_TuleDWR_B$Site.Name <- "Tule Breach"
df_TuleDWR_P$Site.Name <- "Tule Pond"

df_TuleDWR <- rbind.data.frame(df_TuleDWR_B,df_TuleDWR_P)
df_TuleDWR$datetime <- paste(df_TuleDWR$Date..MM.DD.YYYY.,df_TuleDWR$Time..HH.mm.ss.)
df_TuleDWR$dts <- as.POSIXct(strptime(df_TuleDWR$datetime, format = "%m/%d/%Y %H:%M"))
ggplot(df_TuleDWR, aes(x = dts, y = TempC)) + geom_point() + facet_grid(Site.Name~.)

# rename columns and merge all temp, DO, saln, and turbidity
colnames(df_TuleESA)
colnames(df_TuleDWR)
colnames(df_TuleMWQI)
df_TuleESA.2$Depth_m <- NA
df_TuleESA.2$Source <- "ESA"
df_TuleESA_4merge <- df_TuleESA.2[,c("Site","Source","dts","Depth_m","Depth_ft","TempC","DO_mgL","SPC","Turb_NTU")]
df_TuleDWR$Depth_ft <- NA
df_TuleDWR$Source <- "DWR"
df_TuleDWR_4merge <- df_TuleDWR[,c("Site.Name","Source","dts","Depth_m","Depth_ft","TempC","DO_mgL","SPC","Turb_FNU")]
df_TuleMWQI[,c("Site")] <- "Tule Breach"
df_TuleMWQI[,c("Depth_m")] <- NA
df_TuleMWQI[,c("Depth_ft")] <- NA
df_TuleMWQI$Source <- "MWQI"
df_TuleMWQI_4merge <- df_TuleMWQI[,c("Site","Source","dts","Depth_m","Depth_ft","Water Temperature","Dissolved Oxygen","Specific Conductance","Turbidity")]
colnames(df_TuleMWQI_4merge) <- c("Site","Source","dts","Depth_m","Depth_ft","TempC","DO_mgL","SPC","Turb_FNU")
colnames(df_TuleESA_4merge) <- c("Site","Source","dts","Depth_m","Depth_ft","TempC","DO_mgL","SPC","Turb_FNU")
colnames(df_TuleDWR_4merge) <- c("Site","Source","dts","Depth_m","Depth_ft","TempC","DO_mgL","SPC","Turb_FNU")

df_TULEmerge <- rbind.data.frame(df_TuleESA_4merge, df_TuleDWR_4merge, df_TuleMWQI_4merge)

ggplot(df_TULEmerge, aes(x = dts, y = TempC, color = Source)) + geom_point() + facet_grid(Site~.)

save(df_TULEmerge, file = "TULE_LTMsondes_221208.RData")
```

get data from usgs for 2022 (this brings in data retrieved through USGS 'dataRetrieval' package)
```{r}
rm(list = ls())
# First M13
parameterQ <- read.csv("USGS_parameters.csv")
siteAll <- data.frame(read.csv("C:/Users/DCox/OneDrive - California Department of Fish and Wildlife/Documents/FRP/Monitoring/Data/Long Term Water Quality/Datasets/LTWQM_ExternalProgramData/USGS/USGS_M13_siteAll.csv"))

col2get <- data.frame(colnames(siteAll),NA)
col2get[,2] <- stringr::str_match(col2get[,1], "_\\d+")
col2get$parm_cd <- substr(col2get[,2],2,nchar(col2get[,2]))
colnames(col2get) <- c("colsNames","num1","parm_cd")
col2get2 <- merge(col2get,parameterQ[,c(1,3)],by = "parm_cd")


df_M13 <- siteAll[,c(3,14,which(colnames(siteAll) %in% col2get2[c(3,5,8,11,13,15,17),2]))] # 14 here is Dissolved Oxygen (pm code 00300)
colnames(df_M13) <- c("datetime","do","temp","gageFt","spc","ph","fdom","fchl","turb")
df_M13$dts <- as.POSIXct(strptime(df_M13$datetime, format = "%Y-%m-%d %H:%M"))

#save(df_M13, file = "USGS_M13_siteAll.RData")

rm(list = ls())
# Now TOED
parameterQ <- read.csv("USGS_parameters.csv")
siteAll <- data.frame(read.csv("C:/Users/DCox/OneDrive - California Department of Fish and Wildlife/Documents/FRP/Monitoring/Data/Long Term Water Quality/Datasets/LTWQM_ExternalProgramData/USGS/USGS_TOED_siteAll.csv"))

col2get <- data.frame(colnames(siteAll),NA)
col2get[,2] <- stringr::str_match(col2get[,1], "_\\d+")
col2get$parm_cd <- substr(col2get[,2],2,nchar(col2get[,2]))
colnames(col2get) <- c("colsNames","num1","parm_cd")
col2get2 <- merge(col2get,parameterQ[,c(1,3)],by = "parm_cd")


df_TOED <- siteAll[,c(3,12,which(colnames(siteAll) %in% col2get2[c(2,6,7,10,14,15,20),2]))] # 12 here is Dissolved Oxygen (pm code 00300)
colnames(df_TOED) <- c("datetime","do","temp","gageFt","spc","ph","fdom","fchl","turb")
df_TOED$dts <- as.POSIXct(strptime(df_TOED$datetime, format = "%Y-%m-%d %H:%M"))

#save(df_TOED, file = "USGS_TOED_siteAll.RData")


rm(list = ls())
# Now GRZB
parameterQ <- read.csv("USGS_parameters.csv")
siteAll <- data.frame(read.csv("C:/Users/DCox/OneDrive - California Department of Fish and Wildlife/Documents/FRP/Monitoring/Data/Long Term Water Quality/Datasets/LTWQM_ExternalProgramData/USGS/USGS_GRZB_siteAll.csv"))

col2get <- data.frame(colnames(siteAll),NA)
col2get[,2] <- stringr::str_match(col2get[,1], "_\\d+")
col2get$parm_cd <- substr(col2get[,2],2,nchar(col2get[,2]))
colnames(col2get) <- c("colsNames","num1","parm_cd")
col2get2 <- merge(col2get,parameterQ[,c(1,3)],by = "parm_cd")


df_GRZB <- siteAll[,c(3,8,which(colnames(siteAll) %in% col2get2[c(2,3,6,10,11,14),2]))] # 8 here is Dissolved Oxygen (pm code 00300)
colnames(df_GRZB) <- c("datetime","do","temp","spc","ph","fdom","fchl","turb")#,"gageFt"
df_GRZB$dts <- as.POSIXct(strptime(df_GRZB$datetime, format = "%Y-%m-%d %H:%M"))
df_GRZB$gageFt <- NA
df_GRZB.2 <- df_GRZB[,c(1:3,10,4:9)]

save(df_GRZB.2, file = "USGS_GRZB_siteAll.RData")
```



Make windows for looking at chunks of time
```{r}
library(plyr)

load("LTM_CATCH_04.RData")
dfSeasons <- data.frame(mo = c(seq(1,12,1)),
                        season = c(rep("winter",2),
                                   rep("spring",3),
                                   rep("summer",3),
                                   rep("fall",3),
                                   "winter"))

load("FRP_LTMsonde_221207.RData")
unique(df$Site)
#df$dts[which(is.na(df$dts)==TRUE)] <- as.POSIXct(strptime(paste(df$Date[which(is.na(df$dts)==TRUE)],
                                                                #df$Time[which(is.na(df$dts)==TRUE)]),format = "%m/%d/%Y %H:%M:%s"))
df$dts2 <- as.POSIXct(strptime(paste(df$Date, df$Time),format = "%m/%d/%Y %H:%M:%S", tz = "GMT"))


load("TULE_LTMsondes_221208.RData")
colnames(df)
colnames(df_TULEmerge)
df$Source <- "CDFW"
df$Depth_ft <- NA
df.2 <- df[,c("Site","Source","dts","Depthm","Depth_ft","TempC","DOmgL","SPC","Turb")]
colnames(df.2) <- colnames(df_TULEmerge)

dfFRP <- rbind.data.frame(df.2,df_TULEmerge)
dfFRP$sitetype <- "Restoration"

load("ExtLTM_CompleteMerge.RData")
unique(dfAll$site)
df_SDI <- dfAll[which(dfAll$site %in% c("SDI_USGS") & dfAll$dts >= as.POSIXct(strptime("2019-01-01 00:00", format = "%Y-%m-%d %H:%M"))),]
colnames(df_SDI)
df_SDI$Source <- "USGS"
df_SDI$sitetype <- "Adj. Waterbody"
df_SDI$Depth_ft <- NA
df_SDI$Depth_m <- NA
df_SDI.2 <- df_SDI[,c("site","Source","dts","Depth_m","Depth_ft","temp","do","sc","turb","sitetype")]
colnames(df_SDI.2) <- colnames(dfFRP)

load("USGS_M13_siteAll.RData")
load("USGS_TOED_siteAll.RData")
load("USGS_GRZB_siteAll.RData")
df_M13$site <- "M13_USGS"
df_GRZB.2$site <- "GRZB_USGS"
df_TOED$site <- "TOED_USGS"
df_USGS <- rbind.data.frame(df_M13,df_GRZB.2,df_TOED)
df_USGS$Source <- "USGS"
df_USGS$sitetype <- "Adj. Waterbody"
df_USGS$Depth_m <- NA
df_USGS.2 <- df_USGS[,c("site","Source","dts","Depth_m","gageFt","temp","do","spc","turb","sitetype")]
colnames(df_USGS.2) <- colnames(dfFRP)

dfcombined <- rbind.data.frame(dfFRP,df_SDI.2,df_USGS.2)

#dfDeck$slope1 <- dfDeck$Depthm - data.table::shift(dfDeck$Depthm, fill = data.table::first(dfDeck$Depthm))
#dfDeck$EorF <- ifelse(dfDeck$slope1 < 0, "Ebb", "Flood")
dfcombined$threshTemp <- ifelse(dfcombined$TempC > 20, "Suboptimal", "Optimal")
dfcombined$threshTurb <- ifelse(dfcombined$Turb_FNU > 80 | dfcombined$Turb_FNU < 12, "Suboptimal", "Optimal")



dfcombined$mo <- lubridate::month(dfcombined$dts)
dfcombined$date <- lubridate::date(dfcombined$dts)
dfcombined.2 <- merge(dfcombined,dfSeasons, by = "mo")

save(dfcombined.2, file = "AllLTM4Analysis_221208.RData")


```

```{r}
library(plyr)
library(ggplot2)

rm(list = ls())
load("LTM_CATCH_04.RData")
load("AllLTM4Analysis_221208.RData")


summThresh <- ddply(dfcombined.2, c("sitetype","Site","season","date"), summarise,
                    nTemp = length(TempC),
                    oTemp = length(threshTemp[which(threshTemp == "Optimal")]),
                    sTemp = length(threshTemp[which(threshTemp == "Suboptimal")]),
                    nTurb = length(Turb_FNU),
                    oTurb = length(threshTurb[which(threshTurb == "Optimal")]),
                    sTurb = length(threshTurb[which(threshTurb == "Suboptimal")]))

summThresh$nTempCheck <- ifelse(sum(summThresh$oTemp,summThresh$sTemp) == summThresh$nTemp, TRUE, FALSE)
summThresh$nTurbCheck <- ifelse(sum(summThresh$oTurb,summThresh$sTurb) == summThresh$nTurb, TRUE, FALSE)
summThresh$p_oTemp <- summThresh$oTemp/summThresh$nTemp
summThresh$p_oTurb <- summThresh$oTurb/summThresh$nTurb
summThresh$project <- NA
summThresh$project[which(summThresh$Site %in% c("Decker Breach","Decker Pool","M13_USGS","SDI_USGS"))] <- "Decker"
summThresh$project[which(summThresh$Site %in% c("Tule Breach","Tule Channel","Tule Pond","GRZB_USGS"))] <- "Tule"
summThresh$project[which(summThresh$Site %in% c("Yolo Flyway Farm", "TOED_USGS"))] <- "Flyway"
summThresh$project2 <- factor(summThresh$project, levels = c("Flyway","Decker","Tule"))

ggplot(summThresh, aes(x = date, y = p_oTemp, color = sitetype)) + geom_point() + facet_grid(project2 ~.)

library(ggbeeswarm)
pWQviolin <- ggplot(data = dfX3[which(dfX3$variable %in% xWQ),], aes(x = type2, y = as.numeric(value), fill = type)) + # as.Date() needed for jitter to work
  geom_hline(aes(yintercept = as.numeric(thresh1)),linetype = "dashed")+
  geom_hline(aes(yintercept = as.numeric(thresh2)))+
  geom_violin()+
  geom_dotplot(binaxis= "y",
               stackdir = "center",
               dotsize = 1.5) +
  scale_fill_manual(values = mycol) +
  facet_grid(var3 ~ mo2, scales= "free", space = "free_x", switch = "y")+
  theme(axis.title = element_blank(),
        strip.text = element_text(face = "bold"),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.text = element_text(face = "bold")) +
  theme( axis.title.y = element_blank(), # remove the default y-axis title, "wt"
         strip.background = element_rect(fill = 'transparent'), # replace the strip backgrounds with transparent
         strip.placement = 'outside', # put the facet strips on the outside
         strip.text.y = element_text(angle=180),
         axis.text.x = element_text(face = "bold", angle = 90, vjust = 0.5, hjust = 1))
```

Time-series Decomposition For Decker
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)
library(dataRetrieval)
rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde
siteNumber <- "11455485"
parameterCd <- "00065" # Discharge
startDate <- "2021-04-29"
endDate <- "2021-12-31"
#dailyDataAvailable <- whatNWISdata(
#  siteNumber = siteNumber,
#  service = "iv"
#)
parameterQ <- read.csv("USGS_parameters.csv")
#dailyDataAvailable$parameter <- NA
#dailyDataAvailable2 <- merge(dailyDataAvailable, parameterQ[,c(1,3)], by = "parm_cd")
#siteINFO <- readNWISsite(siteNumber)
#siteAll <- readNWISdata(sites = "11455485", service = "iv", startDate = "2021-04-29T00:00", endDate ="2021-12-31T12:00",tz = "America/Los_Angeles")
siteAll <- data.frame(read.csv("USGS_M13_siteAll.csv"))

col2get <- data.frame(colnames(siteAll),NA)
col2get[,2] <- stringr::str_match(col2get[,1], "_\\d+")
col2get$parm_cd <- substr(col2get[,2],2,nchar(col2get[,2]))
colnames(col2get) <- c("colsNames","num1","parm_cd")
col2get2 <- merge(col2get,parameterQ[,c(1,3)],by = "parm_cd")


siteAll2 <- siteAll[,c(3,14,which(colnames(siteAll) %in% col2get2[c(3,5,8,11,13,15,17),2]))]
colnames(siteAll2) <- c("datetime","do","temp","gageFt","spc","ph","fdom","fchl","turb")
siteAll2$dts <- as.POSIXct(strptime(siteAll2$datetime, format = "%Y-%m-%d %H:%M"))


unique(df$Site)
unique(dfAll$site)

df <- df[which(df$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Decker Pool" ),]

df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

df[which(df$dts == "2021-07-30 10:18:04" | df$dts == "2021-07-30 10:33:04"),c(6:14)] <- NA
df$Depthm[which(df$dts == "2021-07-03 21:24:18")] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too


unique(dfAll$site)
#dfAll <- dfAll[which(dfAll$site %in% c("M13_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
#                       dfAll$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
#                       dfAll$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d"))),]

dfAll <- siteAll2[which(siteAll2$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) &
                          siteAll2$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11] <- as.numeric(NA)
colnames(dat)[11] <- c("fdomConc")

dfAll <- dfAll[,-c(1,6)]
dfAll$Site <- "M13"
dfAll[,10:11] <- as.numeric(NA)
dfAll <- dfAll[,c(9,8,2,4,7,1,6,10,11,3,5)]
colnames(dfAll) <- colnames(dat)


dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(unique(Time))) # 96 measurements per day... pTime = sum(frac/4656)*96

dfDeck <- dat3[which(dat3$Station.Code == "Decker Pool" & 
                       dat3$datetimestamp >= as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")) & 
                       dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))),]
dfM13 <- dat3[which(dat3$Station.Code == "M13" & 
                      dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))),]
dfM13 <- dfM13[-nrow(dfM13),]

# change NA to values
dfDeck[which(dfDeck$datetimestamp == as.POSIXct(strptime("2021-08-24 22:18:04",format = "%Y-%m-%d %H:%M:%S"))),"Turb"] <- round(6.21+(6.72-6.21)*.5,2)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"Depthm"] <- c(6.91,6.69,6.47,6.25)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"Turb"] <- c(13.2,13.1,12.9,12.8)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"DOmgL"] <- c(8.1,8.1,8.2,8.2)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"ChlRFU"] <- c(2.63,2.58,2.52,2.47)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"TempC"] <- 20
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"fdomConc"] <- 29.0


#dfDeck$jd <- JD(dfDeck$datetimestamp)
#test <- sunvector(dfDeck$jd, 38.5, -122, -8)
#test2 <- sunpos(test)
#dfDeck$zenith <- test2[,2]

library(wql)
dfDeck$pss <- ec2pss(dfDeck$SPC/1000,dfDeck$TempC) # the variable sc is in microsiemens/cm and must be changed to millisiemens/cm, hence the conversion
dfDeck$calcO2sat <- oxySol(dfDeck$TempC,dfDeck$pss)
dfDeck$satDiff <- (dfDeck$DOmgL/dfDeck$calcO2sat)*100
dfM13$pss <- ec2pss(dfM13$SPC/1000,dfM13$TempC) # the variable sc is in microsiemens/cm and must be changed to millisiemens/cm, hence the conversion
dfM13$calcO2sat <- oxySol(dfM13$TempC,dfM13$pss)
dfM13$satDiff <- (dfM13$DOmgL/dfM13$calcO2sat)*100

dfDeck$slope1 <- dfDeck$Depthm - data.table::shift(dfDeck$Depthm, fill = data.table::first(dfDeck$Depthm))
dfDeck$EorF <- ifelse(dfDeck$slope1 < 0, "Ebb", "Flood")
dfDeck$threshTemp <- ifelse(dfDeck$TempC > 20, "Above", "Below")
dfDeck$threshTurb <- ifelse(dfDeck$Turb > 80 | dfDeck$Turb < 12, "Suboptimal", "Optimal")
dfDeck$threshDOsat <- ifelse(dfDeck$satDiff < 50, "Suboptimal", "Optimal")
dfDeck$EorF[1] <- "Ebb"
dfDeck$DiurnalT <- c(1:10,rep(seq(1:100),37),1:34)

summDeck <- ddply(dfDeck, c("Date","threshTemp","EorF"), summarise,
               nTime = length(unique(Time)),
               lTime = nTime*15,
               mTemp = mean(TempC),
               mTurb = mean(Turb),
               mFDOM = mean(fDOMRFU),
               mChla = mean(ChlRFU))
plo_temp <- ggplot(summDeck, aes(x = Date,y = mTurb, color = EorF)) +
  geom_point()
plo_temp
plo_thresh <- ggplot(summDeck, aes(x = Date,y = lTime/60, color = threshTemp)) +
  geom_point(aes(shape = EorF))
plo_thresh

dfM13$slope1 <- dfM13$Depthm - data.table::shift(dfM13$Depthm, fill = data.table::first(dfM13$Depthm))
dfM13$EorF <- ifelse(dfM13$slope1 < 0, "Ebb", "Flood")
dfM13$threshTemp <- ifelse(dfM13$TempC > 20, "Above", "Below")
dfM13$threshTurb <- ifelse(dfM13$Turb > 80 | dfM13$Turb < 12, "Suboptimal", "Optimal")
dfM13$threshDOsat <- ifelse(dfM13$satDiff < 50, "Suboptimal", "Optimal")
summM13 <- ddply(dfM13, c("Date","threshTemp","EorF"), summarise,
               nTime = length(unique(Time)),
               lTime = nTime*15,
               mTemp = mean(TempC),
               mTurb = mean(Turb),
               mFDOM = mean(fdomConc),
               mChla = mean(ChlRFU))
plo_temp <- ggplot(summM13, aes(x = Date,y = mTurb, color = EorF)) +
  geom_point()
plo_temp
plo_thresh <- ggplot(summM13, aes(x = Date,y = lTime/60, color = threshTemp)) +
  geom_point(aes(shape = EorF))
plo_thresh



dfDeck$day <- as.integer(factor(dfDeck$Date, levels = unique(dfDeck$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),39))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13$frac <- as.integer(rep(c(1:96),39))

deck_ts <- ts(data = dfDeck$TempC,#dfM13$Depthm,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfDeck$Depthm,#dfM13$ChlRFU,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder


both <- ggplot(dfDeck, aes(x = datetimestamp, y = TempC))+
  geom_line(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  #geom_line(data = dfDeck, aes(x = datetimestamp, y = DOmgL +15), color = "red") +
  geom_line(data = dfDeck, aes(x = datetimestamp, y = Depthm*10+15), color = "red")
both

both2 <- ggplot(dfDeck[which(dfDeck$slope1 < 0),], aes(x = datetimestamp, y = TempC))+
  geom_point(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  #geom_line(data = dfDeck, aes(x = datetimestamp, y = DOmgL +15), color = "red") +
  geom_point(data = dfDeck[which(dfDeck$slope1 > 0),], aes(x = datetimestamp, y = TempC), color = "red") + geom_line(data = dfM13, aes(x = datetimestamp, y= TempC), color = "green")
both2
################################################################################
# Using 'WaveletComp' to get wave coherence as in Riml et al. 2019 and Schmidt et al. 2019
tDeck <- data.frame(c(1:3744),deck_mst1[,c("Data")][1:3744])
colnames(tDeck) <- c("timestep","data")
tSacr <- data.frame(c(1:3744),sacr_mst1[,c("Data")][1:3744])
colnames(tSacr) <- c("timestep","data")

library(WaveletComp)
my.data <- data.frame(y =tDeck[,2], x = tSacr[,2])

my.w <- analyze.wavelet(my.data, "x",
                        loess.span = 3/39,
                        dt = 1/96, dj = 1/48,
                        lowerPeriod = 1/24,
                        make.pval = TRUE, n.sim = 10)
wt.image(my.w, color.key = "interval", n.levels = 250,
        legend.params = list(lab = "wavelet power levels"),
        periodlab = "period (days)",
        show.date = TRUE, date.format = "%F", timelab = "")


my.wc <- analyze.coherency(my.data, my.pair = c("x","y"),
                           loess.span = 0,
                           dt = 1/96, dj = 1/48, # 96 observations per day so 1 day is time unit
                           lowerPeriod = 1/12,
                           make.pval = TRUE, n.sim = 10)
wc.image(my.wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "", periodlab = "period (days)")

wc.avg(my.wc, siglvl = 0.01, sigcol = "red", sigpch = 20,
       periodlab = "period (days)")

my.wc2 <- analyze.coherency(my.data, my.pair = c("x","y"),
                            loess.span = 3/39, dt = 1/96, dj = 1/48,
                            window.type.t = 5, window.type.s = 5,
                            window.size.t = 5, window.size.s = 1/2,
                            make.pval = TRUE, n.sim = 10)
wc.image(my.wc2, which.image = "wc", color.key = "interval", n.levels = 250,
         siglvl.contour = 0.1, siglvl.arrow = 0.05, which.arrow.sig = "wt",
         legend.params = list(lab = "wavelet coherence levels"),
         timelab = "")

wc.sel.phases(my.wc2, sel.period = 1.041667, only.sig = TRUE, siglvl = 0.05, # look at graph above to find periods of interest, in this case toggle between 0.51736 and 1.0347
              which.sig = "wt",
              legend.coords = "topleft",
              phaselim = c(-pi, +pi + 1),
              main = "", sub = "", timelab = "")


```



Time-series Decomposition For Flyway
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)
library(dataRetrieval)
rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(df$Site)
unique(dfAll$site)

df <- df[which(df$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Yolo Flyway Farm" ),]

df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

df[which(df$dts == "2021-07-30 10:18:04" | df$dts == "2021-07-30 10:33:04"),c(6:14)] <- NA
df$Depthm[which(df$dts == "2021-07-03 21:24:18")] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too


unique(dfAll$site)
#dfAll <- dfAll[which(dfAll$site %in% c("M13_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
#                       dfAll$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
#                       dfAll$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d"))),]

dfAll <- dfAll[which(dfAll$site %in% c("TOE_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11] <- as.numeric(NA)
colnames(dat)[11] <- c("fdomConc")

dfAll <- dfAll[,-c(1,6)]
dfAll$Site <- "M13"
dfAll[,10:11] <- as.numeric(NA)
dfAll <- dfAll[,c(9,8,2,4,7,1,6,10,11,3,5)]
colnames(dfAll) <- colnames(dat)


dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat$dts <- as.POSIXct(strptime(as.character(dat$dts), format = "%Y-%m-%d %H:%M"))
dfAll$dts <- as.POSIXct(strptime(as.character(dfAll$dts), format = "%Y-%m-%d %H:%M"))

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(unique(Time))) # 96 measurements per day... pTime = sum(frac/4656)*96

dfDeck <- dat3[which(dat3$Station.Code == "Yolo Flyway Farm" #& 
                       #dat3$datetimestamp >= as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")) & 
                       #dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))
                     ),]
dfM13 <- dat3[which(dat3$Station.Code == "M13" #& 
                      #dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))
                    ),]
dfM13 <- dfM13[-nrow(dfM13),]

# change NA to values
dfDeck[which(dfDeck$datetimestamp == as.POSIXct(strptime("2021-08-24 22:18:04",format = "%Y-%m-%d %H:%M:%S"))),"Turb"] <- round(6.21+(6.72-6.21)*.5,2)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"Depthm"] <- c(6.91,6.69,6.47,6.25)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"Turb"] <- c(13.2,13.1,12.9,12.8)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"DOmgL"] <- c(8.1,8.1,8.2,8.2)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"ChlRFU"] <- c(2.63,2.58,2.52,2.47)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"TempC"] <- 20
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"fdomConc"] <- 29.0


#dfDeck$jd <- JD(dfDeck$datetimestamp)
#test <- sunvector(dfDeck$jd, 38.5, -122, -8)
#test2 <- sunpos(test)
#dfDeck$zenith <- test2[,2]

library(wql)
dfDeck$pss <- ec2pss(dfDeck$SPC/1000,dfDeck$TempC) # the variable sc is in microsiemens/cm and must be changed to millisiemens/cm, hence the conversion
dfDeck$calcO2sat <- oxySol(dfDeck$TempC,dfDeck$pss)
dfDeck$satDiff <- (dfDeck$DOmgL/dfDeck$calcO2sat)*100
dfM13$pss <- ec2pss(dfM13$SPC/1000,dfM13$TempC) # the variable sc is in microsiemens/cm and must be changed to millisiemens/cm, hence the conversion
dfM13$calcO2sat <- oxySol(dfM13$TempC,dfM13$pss)
dfM13$satDiff <- (dfM13$DOmgL/dfM13$calcO2sat)*100

dfDeck$slope1 <- dfDeck$Depthm - data.table::shift(dfDeck$Depthm, fill = data.table::first(dfDeck$Depthm))
dfDeck$EorF <- ifelse(dfDeck$slope1 < 0, "Ebb", "Flood")
dfDeck$threshTemp <- ifelse(dfDeck$TempC > 20, "Above", "Below")
dfDeck$threshTurb <- ifelse(dfDeck$Turb > 80 | dfDeck$Turb < 12, "Suboptimal", "Optimal")
dfDeck$threshDOsat <- ifelse(dfDeck$satDiff < 50, "Suboptimal", "Optimal")
dfDeck$EorF[1] <- "Ebb"
#dfDeck$DiurnalT <- c(1:10,rep(seq(1:100),37),1:34)

summDeck <- ddply(dfDeck, c("Date","threshTemp","EorF"), summarise,
               nTime = length(unique(Time)),
               lTime = nTime*15,
               mTemp = mean(TempC),
               mTurb = mean(Turb),
               mFDOM = mean(fDOMRFU),
               mChla = mean(ChlRFU))
plo_temp <- ggplot(summDeck, aes(x = Date,y = mTurb, color = EorF)) +
  geom_point()
plo_temp
plo_thresh <- ggplot(summDeck, aes(x = Date,y = lTime/60, color = threshTemp)) +
  geom_point(aes(shape = EorF))
plo_thresh

dfM13$slope1 <- dfM13$Depthm - data.table::shift(dfM13$Depthm, fill = data.table::first(dfM13$Depthm))
dfM13$EorF <- ifelse(dfM13$slope1 < 0, "Ebb", "Flood")
dfM13$threshTemp <- ifelse(dfM13$TempC > 20, "Above", "Below")
dfM13$threshTurb <- ifelse(dfM13$Turb > 80 | dfM13$Turb < 12, "Suboptimal", "Optimal")
dfM13$threshDOsat <- ifelse(dfM13$satDiff < 50, "Suboptimal", "Optimal")
summM13 <- ddply(dfM13, c("Date","threshTemp","EorF"), summarise,
               nTime = length(unique(Time)),
               lTime = nTime*15,
               mTemp = mean(TempC),
               mTurb = mean(Turb),
               mFDOM = mean(fdomConc),
               mChla = mean(ChlRFU))
plo_temp <- ggplot(summM13, aes(x = Date,y = mTurb, color = EorF)) +
  geom_point()
plo_temp
plo_thresh <- ggplot(summM13, aes(x = Date,y = lTime/60, color = threshTemp)) +
  geom_point(aes(shape = EorF))
plo_thresh



dfDeck$day <- as.integer(factor(dfDeck$Date, levels = unique(dfDeck$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),39))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13$frac <- as.integer(rep(c(1:96),39))

deck_ts <- ts(data = dfDeck$TempC,#dfM13$Depthm,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfDeck$Depthm,#dfM13$ChlRFU,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder


both <- ggplot(dfDeck, aes(x = datetimestamp, y = TempC))+
  geom_line(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  #geom_line(data = dfDeck, aes(x = datetimestamp, y = DOmgL +15), color = "red") +
  geom_line(data = dfDeck, aes(x = datetimestamp, y = Depthm*10+15), color = "red")
both

both2 <- ggplot(dfDeck[which(dfDeck$slope1 < 0),], aes(x = datetimestamp, y = TempC))+
  geom_point(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  #geom_line(data = dfDeck, aes(x = datetimestamp, y = DOmgL +15), color = "red") +
  geom_point(data = dfDeck[which(dfDeck$slope1 > 0),], aes(x = datetimestamp, y = TempC), color = "red") + geom_line(data = dfM13, aes(x = datetimestamp, y= TempC), color = "green")
both2
################################################################################
# Using 'WaveletComp' to get wave coherence as in Riml et al. 2019 and Schmidt et al. 2019
tDeck <- data.frame(c(1:3744),deck_mst1[,c("Data")][1:3744])
colnames(tDeck) <- c("timestep","data")
tSacr <- data.frame(c(1:3744),sacr_mst1[,c("Data")][1:3744])
colnames(tSacr) <- c("timestep","data")

library(WaveletComp)
my.data <- data.frame(y =tDeck[,2], x = tSacr[,2])

my.w <- analyze.wavelet(my.data, "x",
                        loess.span = 3/39,
                        dt = 1/96, dj = 1/48,
                        lowerPeriod = 1/24,
                        make.pval = TRUE, n.sim = 10)
wt.image(my.w, color.key = "interval", n.levels = 250,
        legend.params = list(lab = "wavelet power levels"),
        periodlab = "period (days)",
        show.date = TRUE, date.format = "%F", timelab = "")


my.wc <- analyze.coherency(my.data, my.pair = c("x","y"),
                           loess.span = 0,
                           dt = 1/96, dj = 1/48, # 96 observations per day so 1 day is time unit
                           lowerPeriod = 1/12,
                           make.pval = TRUE, n.sim = 10)
wc.image(my.wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "", periodlab = "period (days)")

wc.avg(my.wc, siglvl = 0.01, sigcol = "red", sigpch = 20,
       periodlab = "period (days)")

my.wc2 <- analyze.coherency(my.data, my.pair = c("x","y"),
                            loess.span = 3/39, dt = 1/96, dj = 1/48,
                            window.type.t = 5, window.type.s = 5,
                            window.size.t = 5, window.size.s = 1/2,
                            make.pval = TRUE, n.sim = 10)
wc.image(my.wc2, which.image = "wc", color.key = "interval", n.levels = 250,
         siglvl.contour = 0.1, siglvl.arrow = 0.05, which.arrow.sig = "wt",
         legend.params = list(lab = "wavelet coherence levels"),
         timelab = "")

wc.sel.phases(my.wc2, sel.period = 1.041667, only.sig = TRUE, siglvl = 0.05, # look at graph above to find periods of interest, in this case toggle between 0.51736 and 1.0347
              which.sig = "wt",
              legend.coords = "topleft",
              phaselim = c(-pi, +pi + 1),
              main = "", sub = "", timelab = "")


```

Time-series Decomposition For Tule Red
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)
library(dataRetrieval)
rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

dfTR <- data.frame(read.csv("TRB_2021_data.csv"))

unique(dfTR$qaqc_flag_id)
dfTR2 <- dfTR[which(dfTR$qaqc_flag_id == "G"),]
dfTR2$dts <- as.POSIXct(strptime(dfTR2$time, format = "%m/%d/%Y %H:%M"))


dfTR3 <- dfTR2[which(dfTR2$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfTR2$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),
               c(6,5,2)]


dfTR4 <- reshape2::dcast(dfTR2, dts ~ analyte_name, value.var = "value")
colnames(dfTR4) <- c("dts","ChlRFU","DOmgL","pH","SPC","Turb","TempC")

dfTR4$Site <- "TuleRed"

xdtsTule <- range(dfTR4$dts)
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("Grizzly_USGS") & #,"Grizzly_CDEC", "GrizzlyL_CDEC" ###DMC: going to use only Grizzly_USGS
                       dfAll$dts >= as.POSIXct(strptime(xdtsTule[1], format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime(xdtsTule[2], format = "%Y-%m-%d"))),]

dat <- dfTR4[,c("Site","dts","TempC","SPC","pH","Turb","DOmgL","ChlRFU")]


#dfAll <- dfAll[,-5]
dfAll <- dfAll[,c("site","dts","temp","sc","ph","turb","do","chl")]
colnames(dfAll) <- colnames(dat)

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(unique(Time))) # 96 measurements per day... pTime = sum(frac/4656)*96

dfDeck <- dat3[which(dat3$Station.Code == "TuleRed" #& 
                       #dat3$datetimestamp >= as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")) & 
                       #dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))
                     ),]
dfM13 <- dat3[which(dat3$Station.Code == "Grizzly_USGS" #& 
                      #dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))
                    ),]
dfM13 <- dfM13[-nrow(dfM13),]

# change NA to values
dfDeck[which(dfDeck$datetimestamp == as.POSIXct(strptime("2021-08-24 22:18:04",format = "%Y-%m-%d %H:%M:%S"))),"Turb"] <- round(6.21+(6.72-6.21)*.5,2)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"Depthm"] <- c(6.91,6.69,6.47,6.25)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"Turb"] <- c(13.2,13.1,12.9,12.8)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"DOmgL"] <- c(8.1,8.1,8.2,8.2)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"ChlRFU"] <- c(2.63,2.58,2.52,2.47)
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"TempC"] <- 20
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 06:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 07:30:00",format = "%Y-%m-%d %H:%M:%S"))),"fdomConc"] <- 29.0


#dfDeck$jd <- JD(dfDeck$datetimestamp)
#test <- sunvector(dfDeck$jd, 38.5, -122, -8)
#test2 <- sunpos(test)
#dfDeck$zenith <- test2[,2]

library(wql)
dfDeck$pss <- ec2pss(dfDeck$SPC/1000,dfDeck$TempC) # the variable sc is in microsiemens/cm and must be changed to millisiemens/cm, hence the conversion
dfDeck$calcO2sat <- oxySol(dfDeck$TempC,dfDeck$pss)
dfDeck$satDiff <- (dfDeck$DOmgL/dfDeck$calcO2sat)*100
dfM13$pss <- ec2pss(dfM13$SPC/1000,dfM13$TempC) # the variable sc is in microsiemens/cm and must be changed to millisiemens/cm, hence the conversion
dfM13$calcO2sat <- oxySol(dfM13$TempC,dfM13$pss)
dfM13$satDiff <- (dfM13$DOmgL/dfM13$calcO2sat)*100

#dfDeck$slope1 <- dfDeck$Depthm - data.table::shift(dfDeck$Depthm, fill = data.table::first(dfDeck$Depthm))
#dfDeck$EorF <- ifelse(dfDeck$slope1 < 0, "Ebb", "Flood")
dfDeck$threshTemp <- ifelse(dfDeck$TempC > 20, "Above", "Below")
dfDeck$threshTurb <- ifelse(dfDeck$Turb > 80 | dfDeck$Turb < 12, "Suboptimal", "Optimal")
#dfDeck$threshDOsat <- ifelse(dfDeck$satDiff < 50, "Suboptimal", "Optimal")
#dfDeck$EorF[1] <- "Ebb"
#dfDeck$DiurnalT <- c(1:10,rep(seq(1:100),37),1:34)

summDeck <- ddply(dfDeck, c("Date","threshTemp"), summarise,
               nTime = length(unique(Time)),
               lTime = nTime*15,
               mTemp = mean(TempC),
               mTurb = mean(Turb),
               #mFDOM = mean(fDOMRFU),
               mChla = mean(ChlRFU))
plo_temp <- ggplot(summDeck, aes(x = Date,y = mTurb, color = EorF)) +
  geom_point()
plo_temp
plo_thresh <- ggplot(summDeck, aes(x = Date,y = lTime/60*(1/24), color = threshTemp)) +
  geom_point()
plo_thresh

#dfM13$slope1 <- dfM13$Depthm - data.table::shift(dfM13$Depthm, fill = data.table::first(dfM13$Depthm))
#dfM13$EorF <- ifelse(dfM13$slope1 < 0, "Ebb", "Flood")
dfM13$threshTemp <- ifelse(dfM13$TempC > 20, "Above", "Below")
dfM13$threshTurb <- ifelse(dfM13$Turb > 80 | dfM13$Turb < 12, "Suboptimal", "Optimal")
#dfM13$threshDOsat <- ifelse(dfM13$satDiff < 50, "Suboptimal", "Optimal")
summM13 <- ddply(dfM13, c("Date","threshTemp"), summarise,
               nTime = length(unique(Time)),
               lTime = nTime*15,
               mTemp = mean(TempC),
               mTurb = mean(Turb),
               #mFDOM = mean(fdomConc),
               mChla = mean(ChlRFU))
#plo_temp <- ggplot(summM13, aes(x = Date,y = mTurb, color = EorF)) +
#  geom_point()
#plo_temp
plo_thresh <- ggplot(summM13, aes(x = Date,y = lTime/60, color = threshTemp)) +
  geom_point()
plo_thresh



dfDeck$day <- as.integer(factor(dfDeck$Date, levels = unique(dfDeck$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),39))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13$frac <- as.integer(rep(c(1:96),39))

deck_ts <- ts(data = dfDeck$TempC,#dfM13$Depthm,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfDeck$Depthm,#dfM13$ChlRFU,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder


both <- ggplot(dfDeck, aes(x = datetimestamp, y = TempC))+
  geom_line(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  #geom_line(data = dfDeck, aes(x = datetimestamp, y = DOmgL +15), color = "red") +
  geom_line(data = dfDeck, aes(x = datetimestamp, y = Depthm*10+15), color = "red")
both

both2 <- ggplot(dfDeck[which(dfDeck$slope1 < 0),], aes(x = datetimestamp, y = TempC))+
  geom_point(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  #geom_line(data = dfDeck, aes(x = datetimestamp, y = DOmgL +15), color = "red") +
  geom_point(data = dfDeck[which(dfDeck$slope1 > 0),], aes(x = datetimestamp, y = TempC), color = "red") + geom_line(data = dfM13, aes(x = datetimestamp, y= TempC), color = "green")
both2
################################################################################
# Using 'WaveletComp' to get wave coherence as in Riml et al. 2019 and Schmidt et al. 2019
tDeck <- data.frame(c(1:3744),deck_mst1[,c("Data")][1:3744])
colnames(tDeck) <- c("timestep","data")
tSacr <- data.frame(c(1:3744),sacr_mst1[,c("Data")][1:3744])
colnames(tSacr) <- c("timestep","data")

library(WaveletComp)
my.data <- data.frame(y =tDeck[,2], x = tSacr[,2])

my.w <- analyze.wavelet(my.data, "x",
                        loess.span = 3/39,
                        dt = 1/96, dj = 1/48,
                        lowerPeriod = 1/24,
                        make.pval = TRUE, n.sim = 10)
wt.image(my.w, color.key = "interval", n.levels = 250,
        legend.params = list(lab = "wavelet power levels"),
        periodlab = "period (days)",
        show.date = TRUE, date.format = "%F", timelab = "")


my.wc <- analyze.coherency(my.data, my.pair = c("x","y"),
                           loess.span = 0,
                           dt = 1/96, dj = 1/48, # 96 observations per day so 1 day is time unit
                           lowerPeriod = 1/12,
                           make.pval = TRUE, n.sim = 10)
wc.image(my.wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "", periodlab = "period (days)")

wc.avg(my.wc, siglvl = 0.01, sigcol = "red", sigpch = 20,
       periodlab = "period (days)")

my.wc2 <- analyze.coherency(my.data, my.pair = c("x","y"),
                            loess.span = 3/39, dt = 1/96, dj = 1/48,
                            window.type.t = 5, window.type.s = 5,
                            window.size.t = 5, window.size.s = 1/2,
                            make.pval = TRUE, n.sim = 10)
wc.image(my.wc2, which.image = "wc", color.key = "interval", n.levels = 250,
         siglvl.contour = 0.1, siglvl.arrow = 0.05, which.arrow.sig = "wt",
         legend.params = list(lab = "wavelet coherence levels"),
         timelab = "")

wc.sel.phases(my.wc2, sel.period = 1.041667, only.sig = TRUE, siglvl = 0.05, # look at graph above to find periods of interest, in this case toggle between 0.51736 and 1.0347
              which.sig = "wt",
              legend.coords = "topleft",
              phaselim = c(-pi, +pi + 1),
              main = "", sub = "", timelab = "")


```


Thermally unsuitable habitat
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)
library(dataRetrieval)
library(WtRegDO)
library(doParallel)
rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde
dfAll <- dfAll[-which(is.na(dfAll$dts)==TRUE),]
dfAll <- dfAll[-which(is.na(dfAll$temp)==TRUE),]

SAPDC <- df[which(df$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Decker Pool" ),
            c(16,14,10,11,7)]
SAPDC <- dfM13[,c(2,3,6,4,10)]
#SAPDC <- dfDeck[,c("datetimestamp","TempC","DOmgL","SPC","Depthm")]
SAPDC$DateTimeStamp <- as.POSIXct(strptime(as.character(SAPDC$dts), format = "%Y-%m-%d %H:%M", tz = "America/Los_Angeles"))
SAPDC <- SAPDC[,-1]
colnames(SAPDC) <- c("Temp","DO_obs","spc","Tide","DateTimeStamp")

rownames(SAPDC) <- NULL
which(duplicated(SAPDC) == TRUE)
#SAPDC <- SAPDC[-c(6761),]#6754,6756,6758,6759,6757
#SAPDC <- SAPDC[-which(SAPDC$Tide > 1000),]
#SAPDC2 <- SAPDC[,c(5,2,4)]
#SAPDC2$lim <- 0.1
#SAPDC2$date <- as.Date(SAPDC2$date)
#tidfit2 <- modfit(SAPDC2, resp_type = "mean")
#fitplot(tidfit2, annuals = FALSE)

# metadata for the location
tz <- 'America/Los_Angeles'
lat <- 38.087387
long <- -121.715627
# setup parallel backend
ncores <- detectCores()  
registerDoParallel(cores = ncores - 1)

evalcor(SAPDC, tz, lat, long, progress = TRUE)

# weighted regression, optimal window widths for SAPDC from the paper
wtreg_res <- wtreg(SAPDC, parallel = TRUE, wins = list(3, 1, 0.6), progress = TRUE, 
  tz = tz, lat = lat, long = long)

do_DT <- ggplot(wtreg_res, aes(x = DateTimeStamp, y = DO_obs), color = "blue") +
  geom_point() +
  geom_point(aes(x = DateTimeStamp, y = DO_prd), color = "red") +
  geom_point(aes(x = DateTimeStamp, y = DO_nrm), color = "green")
do_DT

# estimate ecosystem metabolism using observed DO time series
metab_obs <- ecometab(wtreg_res, DO_var = 'DO_obs', tz = tz, 
  lat = lat, long = long)

# estimate ecosystem metabolism using detided DO time series
metab_dtd <- ecometab(wtreg_res, DO_var = 'DO_nrm', tz = tz, 
  lat = lat, long = long)

df$TUH <- ifelse(df$TempC > 24,1,0)
plo_tuh <- ggplot(df, aes(x = dts, y = TUH, color = Site))+
  geom_point()
#plo_tuh


unique(dfAll$site[which(dfAll$TUH ==1)])
dfAll$year <- lubridate::year(dfAll$dts)
dfAll$year2 <- factor(dfAll$year, levels = c(2016:2021))

dfAll$TUH <- ifelse(dfAll$temp > 24,1,0)
dfAll$TuUH <- ifelse(dfAll$turb < 12 | dfAll$turb > 80, 1, 0)
summTemp <- ddply(dfAll[-which(is.na(dfAll$temp)==TRUE),], c("site","year2"), summarise,
                 N = length(temp),
                 sumTUH = sum(TUH),
                 aveTUH = sumTUH/N)
summTurb <- ddply(dfAll[-which(is.na(dfAll$turb)==TRUE),], c("site","year2"), summarise,
                 N = length(turb),
                 sumTuUH = sum(TuUH),
                 aveTuUH = sumTuUH/N)
#plo_tuh2 <- ggplot(dfAll, aes(x = dts, y = TUH, color = site))+
#  geom_point()
#plo_tuh2
plo_aveTUH <- ggplot(summTemp, aes(x = year2, y = sumTUH, color = site)) +
  geom_point()
plo_aveTUH
plo_aveTuUH <- ggplot(summTurb, aes(x = year2, y = sumTuUH, color = site)) +
  geom_point()
plo_aveTuUH

```

Time-series Decomposition For Decker # this is the older chunk
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(df$Site)
unique(dfAll$site)

df <- df[which(df$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Decker Pool" ),]

df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

df[which(df$dts == "2021-07-30 10:18:04" | df$dts == "2021-07-30 10:33:04"),c(6:14)] <- NA
df$Depthm[which(df$dts == "2021-07-03 21:24:18")] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too


unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("M13_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11:12] <- as.numeric(NA)
colnames(dat)[11:12] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:12] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,8,11,12,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)

dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(unique(Time))) # 96 measurements per day... pTime = sum(frac/4656)*96

dfDeck <- dat3[which(dat3$Station.Code == "Decker Pool" & 
                       dat3$datetimestamp >= as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")) & 
                       dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))),]
dfM13 <- dat3[which(dat3$Station.Code == "M13_USGS" & 
                      dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))),]
dfM13 <- dfM13[-nrow(dfM13),]
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-24 05:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-24 06:30:00",format = "%Y-%m-%d %H:%M:%S"))),"TempC"] <- 20.0

dfDeck$day <- as.integer(factor(dfDeck$Date, levels = unique(dfDeck$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),39))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13$frac <- as.integer(rep(c(1:96),39))

deck_ts <- ts(data = dfDeck$TempC,
              start = c(dfDeck$day[1], dfDeck$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfDeck$Depthm,#dfM13$TempC,
              start = c(dfDeck$day[1], dfDeck$frac[1]),#c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder

#deck.mat <-c(matrix(data = dfDeck$TempC, ncol = length(dfDeck$TempC), nrow = 96, byrow = TRUE))
#deck.ts <- ts(deck.mat, frequency = 96)
#deck.decomp <- decompose(deck.ts)
#autoplot(deck.decomp) + xlab("Year") + ggtitle("Classical Additive Decomposition of Decker Temperature")

autoplot(deck_mst1) + xlab("Year") + ggtitle("STL Decomposition of Electrical Equipment Index")
hist(deck_mst1[,"Remainder"])
#hist(deck_st1$data[,"remainder"])

#plot.frequency.spectrum <- function(X.k, xlimits=c(0,length(X.k))) {
#  plot.data  <- cbind(0:(length(X.k)-1), Mod(X.k))

  # TODO: why this scaling is necessary?
#  plot.data[2:length(X.k),2] <- 2*plot.data[2:length(X.k),2] 
#  
#  plot(plot.data, t="h", lwd=2, main="", 
#       xlab="Frequency (Hz)", ylab="Strength", 
#       xlim=xlimits, ylim=c(0,max(Mod(plot.data[,2]))))
#}
#X.k <- fft(deck_mst1[,"Remainder"])
#plot.frequency.spectrum(X.k,xlimits=c(0,acq.freq/2))

################################################################################
### for deck
plot(deck_mst1[,"Remainder"])
f.data <- GeneCycle::periodogram(deck_mst1[,"Remainder"])
harmonics <- 1:96
plot(f.data$freq[harmonics]*length(deck_mst1[,"Remainder"]), 
     f.data$spec[harmonics]/sum(f.data$spec), 
     xlab="Harmonics (Hz)", ylab="Amplitute Density", type="h")

f.data2 <- data.frame(freq = as.numeric(f.data$freq),
                      spec = as.numeric(f.data$spec))
f.data2$period.hr <- (1/f.data2$freq)*15/60
f.data2$freq.hr <- 1/f.data2$period.hr
plot(f.data2$period.hr[which(f.data2$period.hr < 100)], f.data2$spec[which(f.data2$period.hr < 100)], type = "h")

ccf(deck_mst1[,"Remainder"],sacr_mst1[,"Remainder"])

library(psdr)
Fs <- 1/(15*60) # 15 minutes times 60 seconds per 1 minute is 900 seconds, so frequency is 1 per 900 seconds or 0.001111 Hz
results <- MakePowerSpectralDensity(Fs,deck_mst1[,"Remainder"])
frequencies <- results[[1]]
PSD <- results[[2]]
p.data2 <- data.frame(frequencies, PSD)
p.data2$logFreq.hr <- log(p.data2$frequencies*3600)
p.data2$period.hr <- (1/p.data2$frequencies) * (1/60) * (1/60)
plot(frequencies[-1], PSD[-1], type = "l")
plot(p.data2$period.hr[which(p.data2$period.hr < 100)], p.data2$PSD[which(p.data2$period.hr < 100)], type = "h")
################################################################################


################################################################################
### for sacr
plot(sacr_mst1[,"Remainder"])
f.data <- GeneCycle::periodogram(sacr_mst1[,"Remainder"])
harmonics <- 1:96
plot(f.data$freq[harmonics]*length(deck_mst1[,"Remainder"]), 
     f.data$spec[harmonics]/sum(f.data$spec), 
     xlab="Harmonics (Hz)", ylab="Amplitute Density", type="h")

f.data2sacr <- data.frame(freq = as.numeric(f.data$freq),
                      spec = as.numeric(f.data$spec))
f.data2sacr$period.hr <- (1/f.data2sacr$freq)*15/60
f.data2sacr$freq.hr <- 1/f.data2sacr$period.hr
plot(f.data2sacr$period.hr[which(f.data2sacr$period.hr < 100)], f.data2sacr$spec[which(f.data2sacr$period.hr < 100)], type = "h")

library(psdr)
Fs <- 1/(15*60) # 15 minutes times 60 seconds per 1 minute is 900 seconds, so frequency is 1 per 900 seconds or 0.001111 Hz
results <- MakePowerSpectralDensity(Fs,sacr_mst1[,"Remainder"])
frequencies <- results[[1]]
PSD <- results[[2]]
p.data2sacr <- data.frame(frequencies, PSD)
p.data2sacr$period.hr <- (1/p.data2sacr$frequencies) * (1/60) * (1/60)
plot(frequencies[-1], PSD[-1], type = "l")
plot(p.data2sacr$period.hr[which(p.data2sacr$period.hr < 100)], p.data2sacr$PSD[which(p.data2sacr$period.hr < 100)], type = "h")
################################################################################

p.data2$psd2 <- p.data2$PSD/sum(p.data2$PSD)
p.data2sacr$psd2 <- p.data2sacr$PSD/sum(p.data2sacr$PSD)
psd.comp <- ggplot(data = p.data2[which(p.data2$period.hr < 50 & p.data2$psd2 > 0.001),], aes(x = period.hr, y = log10(psd2))) +
  geom_point(color = "blue") +
  geom_point(data = p.data2sacr[which(p.data2sacr$period.hr < 50& p.data2sacr$psd2 > 0.001),], color = "red")

psd.comp2 <- ggplot(data = p.data2, aes(x = log(frequencies*3600), y = log10(psd2))) +
  geom_line(color = "blue") +
  geom_line(data = p.data2sacr, color = "red")
hist(dfDeck$TempC)

# this follows format of Riml et al. 2019
psd.comp3 <- ggplot(data = p.data2, aes(x = log10(period.hr/24), y = log10(psd2))) +
  geom_line(color = "blue")+
  geom_line(data = p.data2sacr, color = "red") +
  geom_vline(xintercept = log10(0.5))+
  geom_vline(xintercept = log10(1)) +
  xlab("Period (days)") +
  ylab("Power Spectral Density")
psd.comp3

#this follows format of Guayadol et al. 2014
psd.comp4 <- ggplot(data = p.data2, aes(x = log10(frequencies), y = log10(psd2))) +
  geom_line(color = "blue")+
  geom_line(data = p.data2sacr, color = "red") +
  geom_vline(xintercept = log10(1/(12*3600)))+ #-4.635484
  geom_vline(xintercept = log10(1/(24*3600))) #-4.936514
psd.comp4

################################################################################
# Using 'gsignal' to get PSD with Welch's method (default Hammer window)
library(gsignal)
pwDeck <- pwelch(deck_mst1[,"Remainder"][1:3744]+deck_mst1[,"Remainder"][1:3744], fs = Fs, detrend = "long-linear") # detrend is off since already detrended
plot(pwDeck)
pwSacr <- pwelch(sacr_mst1[,"Remainder"][1:3744], fs = Fs, detrend = "none") # detrend is off since already detrended
plot(pwSacr)

pwBoth <- pwelch(cbind(sacr_mst1[,"Remainder"][1:3744],deck_mst1[,"Remainder"][1:3744]), fs = Fs, detrend = "none") # detrend is off since already detrended
plot(pwBoth, plot.type = "coherence")
################################################################################
#Using 'biwavelet' to get wave coherence as in Riml et al. 2019 and Schmidt et al. 2019
library(biwavelet)
tDeck <- data.frame(c(1:3744),deck_mst1[,c("Data")][1:3744])
colnames(tDeck) <- c("timestep","data")
tSacr <- data.frame(c(1:3744),sacr_mst1[,c("Data")][1:3744])
colnames(tSacr) <- c("timestep","data")
nrands <- 100

wtc.AB = wtc(tDeck, tSacr, nrands = nrands)

par(oma = c(0, 0, 0, 1), mar = c(5, 4, 5, 5) + 0.1)
plot(wtc.AB, plot.phase = TRUE, lty.coi = 1, col.coi = "grey", lwd.coi = 2, 
    lwd.sig = 2, arrow.lwd = 0.03, arrow.len = 0.12, ylab = "Scale", xlab = "Period", 
    plot.cb = TRUE, main = "Wavelet Coherence: A vs B")

# Adding grid lines
n = length(tDeck[, 1])
abline(v = seq(288, n, 288), h = 1:16, col = "brown", lty = 1, lwd = 1)

# Defining x labels
axis(side = 3, at = c(seq(0, n, 288)), labels = c(seq(0, n, 288)))

bothTemp <- ggplot(dfDeck, aes(x = datetimestamp, y = TempC))+
  geom_line(color = "blue") +
  #geom_line(data = dfM13, aes(x = datetimestamp, y = TempC), color = "red")
  geom_line(data = dfDeck, aes(x = datetimestamp, y = Depthm*8+16), color = "red")
bothTemp

################################################################################
# Using 'WaveletComp' to get wave coherence as in Riml et al. 2019 and Schmidt et al. 2019
library(WaveletComp)
my.data <- data.frame(y =tDeck[,2], x = tSacr[,2])

my.w <- analyze.wavelet(my.data, "x",
                        loess.span = 0,
                        dt = 1/96, dj = 1/96,
                        lowerPeriod = 1/24,
                        make.pval = TRUE, n.sim = 10)
wt.image(my.w, color.key = "interval", n.levels = 250,
        legend.params = list(lab = "wavelet power levels"),
        periodlab = "period (days)",
        show.date = TRUE, date.format = "%F", timelab = "")


my.wc <- analyze.coherency(my.data, my.pair = c("x","y"),
                           loess.span = 0,
                           dt = 1/96, dj = 1/48, # 96 observations per day so 1 day is time unit
                           lowerPeriod = 1/12,
                           make.pval = TRUE, n.sim = 10)
wc.image(my.wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "", periodlab = "period (days)")

wc.avg(my.wc, siglvl = 0.01, sigcol = "red", sigpch = 20,
       periodlab = "period (days)")

my.wc2 <- analyze.coherency(my.data, my.pair = c("x","y"),
                            loess.span = 3/39, dt = 1/96, dj = 1/48,
                            window.type.t = 5, window.type.s = 5,
                            window.size.t = 5, window.size.s = 1/2,
                            make.pval = TRUE, n.sim = 10)
wc.image(my.wc2, which.image = "wc", color.key = "interval", n.levels = 250,
         siglvl.contour = 0.1, siglvl.arrow = 0.05, which.arrow.sig = "wt",
         legend.params = list(lab = "wavelet coherence levels"),
         timelab = "")

wc.sel.phases(my.wc2, sel.period = 0.55, only.sig = TRUE, siglvl = 0.05, # look at graph above to find periods of interest, in this case toggle between 0.5 and 1
              which.sig = "wt",
              legend.coords = "topleft",
              phaselim = c(-pi, +pi + 1),
              main = "", sub = "", timelab = "")


################################################################################
#Below has the intervals for each frequency group fashioned after Guayadol et al. 2014
p.data2$id <- order(p.data2$frequencies)
AUC <- sum(diff(p.data2$frequencies[p.data2$id])*rollmean(p.data2$PSD[p.data2$id],2))

library(MESS)
i.Total <- auc(p.data2$frequencies,p.data2$PSD, type = 'spline')
i.Week <- auc(p.data2$frequencies[which(p.data2$period.hr > 27)],
    p.data2$PSD[which(p.data2$period.hr > 27)],
    type = 'spline')
i.Day <- auc(p.data2$frequencies[which(p.data2$period.hr > 21 & p.data2$period.hr < 27)],
    p.data2$PSD[which(p.data2$period.hr > 21 & p.data2$period.hr < 27)],
    type = 'spline')
i.h2fDay <- auc(p.data2$frequencies[which(p.data2$period.hr > 14 & p.data2$period.hr < 21)],
    p.data2$PSD[which(p.data2$period.hr > 14 & p.data2$period.hr < 21)],
    type = 'spline')
i.hDay <- auc(p.data2$frequencies[which(p.data2$period.hr > 10 & p.data2$period.hr < 14)],
    p.data2$PSD[which(p.data2$period.hr > 10 & p.data2$period.hr < 14)],
    type = 'spline')
i.Hourly <- auc(p.data2$frequencies[which(p.data2$period.hr > 0.333 & p.data2$period.hr < 10)],
    p.data2$PSD[which(p.data2$period.hr > 0.333 & p.data2$period.hr < 10)],
    type = 'spline')

i.Week/i.Total
i.Day/i.Total
i.h2fDay/i.Total
i.hDay /i.Total
i.Hourly/i.Total

sum.d.Total <- sum(p.data2$PSD)
sum.d.Week <- sum(p.data2$PSD[which(p.data2$period.hr > 27)])
sum.d.Day <- sum(p.data2$PSD[which(p.data2$period.hr > 21 & p.data2$period.hr < 27)])
sum.d.h2fDay <- sum(p.data2$PSD[which(p.data2$period.hr > 14 & p.data2$period.hr < 21)])
sum.d.hDay <- sum(p.data2$PSD[which(p.data2$period.hr > 10 & p.data2$period.hr < 14)])
sum.d.qDay <- sum(p.data2$PSD[which(p.data2$period.hr > 6 & p.data2$period.hr < 10)])
sum.d.Hourly <- sum(p.data2$PSD[which(p.data2$period.hr > 0.333 & p.data2$period.hr < 6)])

sum.s.Total <- sum(p.data2sacr$PSD)
sum.s.Week <- sum(p.data2sacr$PSD[which(p.data2sacr$period.hr > 27)])
sum.s.Day <- sum(p.data2sacr$PSD[which(p.data2sacr$period.hr > 21 & p.data2sacr$period.hr < 27)])
sum.s.h2fDay <- sum(p.data2sacr$PSD[which(p.data2sacr$period.hr > 14 & p.data2sacr$period.hr < 21)])
sum.s.hDay <- sum(p.data2sacr$PSD[which(p.data2sacr$period.hr > 10 & p.data2sacr$period.hr < 14)])
sum.s.qDay <- sum(p.data2sacr$PSD[which(p.data2sacr$period.hr > 6 & p.data2sacr$period.hr < 10)])
sum.s.Hourly <- sum(p.data2sacr$PSD[which(p.data2sacr$period.hr > 0.333 & p.data2sacr$period.hr < 6)])

p.d.Week <- sum.d.Week/sum.d.Total
p.d.Day <- sum.d.Day/sum.d.Total
p.d.h2fDay <- sum.d.h2fDay/sum.d.Total
p.d.hDay <- sum.d.hDay/sum.d.Total
p.d.qDay <- sum.d.qDay/sum.d.Total
p.d.Hourly <- sum.d.Hourly/sum.d.Total

p.s.Week <- sum.s.Week/sum.s.Total
p.s.Day <- sum.s.Day/sum.s.Total
p.s.h2fDay <- sum.s.h2fDay/sum.s.Total
p.s.hDay <- sum.s.hDay/sum.s.Total
p.s.qDay <- sum.s.qDay/sum.s.Total
p.s.Hourly <- sum.s.Hourly/sum.s.Total

sd.d.Week <- sqrt(sum(p.d.Day,p.d.h2fDay,p.d.hDay,p.d.qDay,p.d.Hourly))
sd.d.Day <- sqrt(sum(p.d.h2fDay,p.d.hDay,p.d.qDay,p.d.Hourly))
sd.d.h2fDay <- sqrt(sum(p.d.hDay,p.d.qDay,p.d.Hourly))
sd.d.hDay <- sqrt(sum(p.d.qDay,p.d.Hourly))
sd.d.qDay <- sqrt(sum(p.d.Hourly))

p.data2 <- data.frame(apply(p.data2, 2, rev))

p.data2$vari <- cumsum(p.data2$PSD)
p.data2$sdm <- sqrt(p.data2$vari)
plot(log(p.data2$period.hr),log(p.data2$sdm))
exp(2)

x1 <- log(p.data2$period.hr[which(p.data2$period.hr< 13)])
y1 <- log(p.data2$sdm[which(p.data2$period.hr< 13)])
mod <- lm(y1 ~ x1)
cf <- coef(mod)

x2 <- log(p.data2$period.hr[which(p.data2$period.hr> 13 & p.data2$period.hr != Inf)])
y2 <- log(p.data2$sdm[which(p.data2$period.hr> 13 & p.data2$period.hr != Inf)])
mod2 <- lm(y2 ~ x2)
cf2 <- coef(mod2)


sd.s.Week <- sqrt(sum(p.s.Day,p.s.h2fDay,p.s.hDay,p.s.qDay,p.s.Hourly))
sd.s.Day <- sqrt(sum(p.s.h2fDay,p.s.hDay,p.s.qDay,p.s.Hourly))
sd.s.h2fDay <- sqrt(sum(p.s.hDay,p.s.qDay,p.s.Hourly))
sd.s.hDay <- sqrt(sum(p.s.qDay,p.s.Hourly))
sd.s.qDay <- sqrt(sum(p.s.Hourly))

p.data2sacr <- data.frame(apply(p.data2sacr, 2, rev))
p.data2sacr$vari <- cumsum(p.data2sacr$PSD)
p.data2sacr$sdm <- sqrt(p.data2sacr$vari)
plot(log(p.data2sacr$period.hr),log(p.data2sacr$sdm))
exp(2)

s.x1 <- log(p.data2sacr$period.hr[which(p.data2sacr$period.hr< 13)])
s.y1 <- log(p.data2sacr$sdm[which(p.data2sacr$period.hr< 13)])
s.mod <- lm(s.y1 ~ s.x1)
s.cf <- coef(s.mod)

s.x2 <- log(p.data2sacr$period.hr[which(p.data2sacr$period.hr> 13 & p.data2sacr$period.hr != Inf)])
s.y2 <- log(p.data2sacr$sdm[which(p.data2sacr$period.hr> 13 & p.data2sacr$period.hr != Inf)])
s.mod2 <- lm(s.y2 ~ s.x2)
s.cf2 <- coef(s.mod2)

# Regional Kendall Test
library(EnvStats)
both <- rbind.data.frame(dfDeck, dfM13)
kendallSeasonalTrendTest(TempC ~ Station.Code, data = both)

library(rkt)
?rkt
both$frac <- c(rep(1:3744,2))
both$block <- c(rep(1,3744),rep(2,3744))
both$yrfrac <- as.numeric(paste(2021,both$frac, sep = "."))
rkt(both$yrfrac, y = both$TempC, block = both$block)

### Applying high-pass filter
library(dplR)
filt.deck <- pass.filt(dfDeck$TempC, 10,type = "high", method = "Butterworth")

to_plo_sub <- rbind.data.frame(dfDeck, dfM13)
#to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Decker Pool", "M13_USGS"))

mycol <- (viridis_pal(option = "H")(56))[c(24,44)]
#mycol[3] <- c("black")
mysh <- c(25,21)
myps <- c(1.5,1.3)
myalf <- c(0.5,1)

xdtsJuly <- c(as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-09-09 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsJuly[1] &  to_plo_sub$datetimestamp <= xdtsJuly[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))

plo_agg_Trend <- ggplot(to_plo_sub, aes(x = datetimestamp, y = seas_adj, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = TempC, color = Station.Code)) +
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = trend, alpha = Station.Code), color = "black") +
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 20, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  scale_color_manual(values = mycol,labels = c("Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','fDOMRFU','fdomConc','PCRFU','Depthm'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU),
               #Chlconcbar = mean(Chlconc),
               fDOMRFUbar = mean(fDOMRFU),
               fDOMconcbar = mean(fdomConc),
               PCbar = mean(PCRFU),
               Depthbar = mean(Depthm)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Decker Breach", "Decker Pool", "M13_USGS"))#, "SacSherman_CDEC", "SDI_USGS", "Emmaton_CDEC"
                                  #labels = c("P","B","S","Y","T"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]

to_plo_sub$ord <- as.numeric(to_plo_sub$Station.Code)
to_plo_sub <- to_plo_sub[order(to_plo_sub$ord),]

unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","Toe Drain")
decker <- c("Decker Breach","Decker Pool","M13_USGS") # ,"SacSherman_CDEC" has info #,"SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Pool" | to_plo_sub$Station.Code == "Decker Breach")]
xdtsDeck2 <- range(xdtsDeck)

mycol <- (viridis_pal(option = "H")(56))[c(24,44,33)]
mycol[3] <- c("black")
mysh <- c(25,21,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)

xdtsSpring1 <- c(as.POSIXct(strptime("2021-04-19 00:00", format = "%Y-%m-%d")),
                 as.POSIXct(strptime("2021-05-10 00:00", format = "%Y-%m-%d")))
xdtsSpring2 <- c(as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")),
                 as.POSIXct(strptime("2021-05-30 00:00", format = "%Y-%m-%d")))
xdtsJune <- c(as.POSIXct(strptime("2021-06-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-06-30 00:00", format = "%Y-%m-%d")))
xdtsJuly <- c(as.POSIXct(strptime("2021-07-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")))
xdtsAug <- c(as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-08-30 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))


plo_agg_subTsub <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2] & to_plo_sub$variable == "Tempbar"),], aes(x = datetimestamp, y = value, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  scale_color_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subDep <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2] & to_plo_sub$variable == "Depthbar"),], aes(x = datetimestamp, y = value, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  #geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  #geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 0, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  ylim(-0.1,1.5) +
  scale_color_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_fill_manual(values = c("white","black"),labels = c("Full","New")) + 
  theme_classic() +
  xlab("Date") +
  ylab("Depth (m)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subTsub, plo_agg_subDep,nrow = 2), ncol =1)
```


Time-series Decomposition For Flyway
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(df$Site)

df <- df[which(df$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-08-31 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Yolo Flyway Farm" ),]

df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

#df[which(df$dts == "2021-07-30 10:18:04" | df$dts == "2021-07-30 10:33:04"),c(6:14)] <- NA
#df$Depthm[which(df$dts == "2021-07-03 21:24:18")] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too


unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("TOE_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-08-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11:12] <- as.numeric(NA)
colnames(dat)[11:12] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:12] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,8,11,12,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)

dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(Time)) # 96 measurements per day

dfDeck <- dat3[which(dat3$Station.Code == "Yolo Flyway Farm"),]
dfM13 <- dat3[which(dat3$Station.Code == "TOE_USGS" & dat3$Date != "2021-08-31"),]

dfDeck$day <- as.integer(factor(df$Date, levels = unique(df$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),30))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13$frac <- as.integer(rep(c(1:96),30))

deck_ts <- ts(data = dfDeck$TempC,
              start = c(dfDeck$day[1], dfDeck$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfM13$TempC,
              start = c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder

to_plo_sub <- rbind.data.frame(dfDeck, dfM13)
#to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Yolo Flyway Farm", "TOE_USGS"))

mycol <- (viridis_pal(option = "H")(56))[c(24,44)]
#mycol[3] <- c("black")
mysh <- c(25,21)
myps <- c(1.5,1.3)
myalf <- c(0.5,1)

xdtsJuly <- c(as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-08-31 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsJuly[1] &  to_plo_sub$datetimestamp <= xdtsJuly[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))

plo_agg_Trend <- ggplot(to_plo_sub, aes(x = datetimestamp, y = seas_adj, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = TempC, color = Station.Code)) +
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = trend, alpha = Station.Code), color = "black") +
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 20, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  scale_color_manual(values = mycol,labels = c("Flyway","Toe\nDrain")) + 
  scale_shape_manual(values = mysh,labels = c("Flyway","Toe\nDrain")) +
  scale_size_manual(values = myps,labels = c("Flyway","Toe\nDrain")) +
  scale_alpha_manual(values = myalf,labels = c("Flyway","Toe\nDrain")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
```