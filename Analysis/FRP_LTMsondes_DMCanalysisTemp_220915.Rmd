---
title: "FRP_LTMsonde analysis"
author: "DMC"
date: "5/25/2022"
output: html_document
---


This file contains a preliminary view of the long-term sonde deployments for Yolo Flyway Farms and Decker (breach + pool)
OLD - DMC210722 - this was modified to include the new compiled data perfomed by DMC on 210722
DMC220526 - this was modified to work with the new compiled data performed by DMC on 220525

```{r}
rm(list = ls())

df_DeckB <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_DeckerBreach.csv"))
df_DeckB$Site.Name <- c("Decker Breach")
df_DeckP <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_DeckerPool.csv"))
df_DeckP$Site.Name <- c("Decker Pool")
df_YoloF <- data.frame(read.csv(file = "DMC_CompileDataRaw4R_YoloFlyway.csv"))
df_YoloF$Site.Name <- c("Yolo Flyway Farm")
df <- rbind.data.frame(df_DeckB,df_DeckP,df_YoloF)
colnames(df) <- c("SondeName","Date","Time","tFracSec","Site","ChlRFU","Depthm","fDOMRFU","DOsat","DOmgL","SPC","PCRFU","Turb","TempC","WiperPos")
df$dts <- paste(df$Date,df$Time,sep = " ")
df$dts <- as.POSIXct(strptime(df$dts, format = "%m/%d/%Y %H:%M:%S"))
df$Chlconc <- c(rep(NA,length(df$SondeName)))
df$fDOMconc <- c(rep(NA,length(df$SondeName)))

save(df, file = "FRP_LTMsonde_220526.RData") ###DMC220714: saved again to include Decker Breach data from 210414-210707
```

This chunk will replicate the work by Mandy (again). For Decker
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

df <- df[which(df$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d")) &
                 df$Site != "Yolo Flyway Farm"),]
df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("M13_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11:12] <- as.numeric(NA)
colnames(dat)[11:12] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:12] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,11,8,9,12)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)

dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")


dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','fDOMRFU','fdomConc','PCRFU','Depthm'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU),
               #Chlconcbar = mean(Chlconc),
               fDOMRFUbar = mean(fDOMRFU),
               fDOMconcbar = mean(fdomConc),
               PCbar = mean(PCRFU),
               Depthbar = mean(Depthm)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Decker Breach", "Decker Pool", "M13_USGS"))#, "SacSherman_CDEC", "SDI_USGS", "Emmaton_CDEC"
                                  #labels = c("P","B","S","Y","T"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]

to_plo_sub$ord <- as.numeric(to_plo_sub$Station.Code)
to_plo_sub <- to_plo_sub[order(to_plo_sub$ord),]

unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","Toe Drain")
decker <- c("Decker Breach","Decker Pool","M13_USGS") # ,"SacSherman_CDEC" has info #,"SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Pool" | to_plo_sub$Station.Code == "Decker Breach")]
xdtsDeck2 <- range(xdtsDeck)

mycol <- (viridis_pal(option = "H")(56))[c(24,44,33)]
mycol[3] <- c("black")
mysh <- c(25,21,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)

xdtsSpring1 <- c(as.POSIXct(strptime("2021-04-19 00:00", format = "%Y-%m-%d")),
                 as.POSIXct(strptime("2021-05-10 00:00", format = "%Y-%m-%d")))
xdtsSpring2 <- c(as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")),
                 as.POSIXct(strptime("2021-05-30 00:00", format = "%Y-%m-%d")))
xdtsJune <- c(as.POSIXct(strptime("2021-06-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-06-30 00:00", format = "%Y-%m-%d")))
xdtsJuly <- c(as.POSIXct(strptime("2021-07-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")))
xdtsAug <- c(as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-08-30 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))


plo_agg_subTsub <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2] & to_plo_sub$variable == "Tempbar"),], aes(x = datetimestamp, y = value, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  scale_color_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subDep <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2] & to_plo_sub$variable == "Depthbar"),], aes(x = datetimestamp, y = value, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  #geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  #geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 0, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  ylim(-0.1,1.5) +
  scale_color_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_fill_manual(values = c("white","black"),labels = c("Full","New")) + 
  theme_classic() +
  xlab("Date") +
  ylab("Depth (m)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subTsub, plo_agg_subDep,nrow = 2), ncol =1)


plo_agg_subDO <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "DObar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code,shape = Station.Code, size = Station.Code)) +
  geom_point(colour = "black") +
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


mycol
to_plo_sub2 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "M13_USGS"),], #"SacSherman_CDEC"
                                to_plo_sub[which(to_plo_sub$Station.Code == "Decker Breach"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "Decker Pool"),])
plo_agg_subSPC <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% decker & (to_plo_sub2$datetimestamp >= xdtsDeck2[1] & to_plo_sub2$datetimestamp <= xdtsDeck2[2]) & to_plo_sub2$variable == "SPCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_point(color = "#36454F") + #colour = "black"
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Specific Conductivity (\u00B5S/cm)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subSPC + annotation_custom(grob = ggplotGrob(plo_agg_subSPC +ylim(0,2100) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2020-01-05",format = "%Y-%m-%d")),
                                         ymin = 375, ymax = 675)


###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
plo_agg_subTu <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% decker & (to_plo_sub2$datetimestamp >= xdtsDeck2[1] & to_plo_sub2$datetimestamp <= xdtsDeck2[2]) & to_plo_sub2$variable == "Turbbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(colour = "black") +
  geom_hline(yintercept=12, linetype = "dashed")+ #Grimaldo LF, Sommer T, Van Ark N, Jones G, Holland E, Moyle PB, Smith P, Herbold B. 2009a. Factors affecting fish entrainment into massive water diversions in a freshwater tidal estuary: Can fish losses be managed? N Am J Fish Manage 29:1253-1270.
  geom_hline(yintercept=80) + # Can also use this for the above '12' turbidity value too: Hasenbein M, Fangue NA, Geist J, Komoroske LM, Truong J, McPherson R, Connon RE (2016) Assessments at multiple levels of biological organization allow for an integrative determination of physiological tolerances to turbidity in an endangered fish species. Conserv Physiol 4: doi:10.1093/conphys/cow004.
  scale_fill_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = c(myalf[1:2],0.4),labels = c("Breach","Interior","Sacramento\nRiver")) +
  #ylim(0,400)+
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

pl2 <- plo_agg_subTu + annotation_custom(grob = ggplotGrob(plo_agg_subTu +ylim(0,125) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-07-07",format = "%Y-%m-%d")),
                                         ymin = 225, ymax = 425)


deckerOnly <- decker[1:2]
plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & to_plo_sub$variable == "ChlRFUbar" & to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]),], aes(x = datetimestamp, y = value, fill = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior")) +
  scale_y_continuous(breaks = seq(0,2,1), limits = c(0,2))+
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subChl + annotation_custom(grob = ggplotGrob(plo_agg_subChl + ylim(0,45) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-08-10",format = "%Y-%m-%d")),
                                         ymin = 1.2, ymax =2.1)

sac <- decker[3]
plo_agg_subChlsac <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% sac & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "ChlRFUbar"),], aes(x = as.Date(datetimestamp), y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[3],labels = c("Sac.\nRiver   "))+ 
  scale_shape_manual(values = mysh[3],labels = c("Sac.\nRiver   ")) +
  scale_size_manual(values = myps[3],labels = c("Sac.\nRiver   ")) +
  scale_x_date(limits = as.Date(c(xdtsDeck2[1], xdtsDeck2[2]))) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (\u00B5g/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
gridExtra::grid.arrange(arrangeGrob(pl2, plo_agg_subChlsac,nrow = 2), ncol =1)





deckerOnly <- decker[1:2]
plo_agg_subPC <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "PCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  theme_classic() +
  xlab("Date") +
  ylab("Phycocyanin (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <- plo_agg_subPC + annotation_custom(grob = ggplotGrob(plo_agg_subPC +ylim(0,5) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-07-25",format = "%Y-%m-%d")),
                                         ymin = 25, ymax = 50)

deckerOnly <- decker[1:2]
plo_agg_subfdom <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "fDOMRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  theme_classic() +
  #ylim(0,5) +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


sac <- decker[3]
plo_agg_subfdomsac <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% sac & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "fDOMconcbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  xlim(xdtsDeck2) +
  scale_fill_manual(values = mycol[3],labels = c("Sac.\nRiver   "))+ 
  scale_shape_manual(values = mysh[3],labels = c("Sac.\nRiver   ")) +
  scale_size_manual(values = myps[3],labels = c("Sac.\nRiver   ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (mg/L as QSE)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


gridExtra::grid.arrange(arrangeGrob(plo_agg_subfdom, plo_agg_subfdomsac,nrow = 2), ncol =1)


deckerOnly <- decker[1:2]
to_plo_sub$value[which(to_plo_sub$variable == "Depthbar" & to_plo_sub$value >500)] <- NA
plo_agg_subdepth <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "Depthbar"),], aes(x = datetimestamp, y = value, colour = Station.Code, shape = Station.Code, size = Station.Code)) +
  #geom_point(alpha = 0.5, colour = "black") +
  geom_line(size =0.5)+
  scale_color_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  theme_classic() +
  #ylim(0,5) +
  xlab("Date") +
  ylab("Depth (m)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


deckerOnly <- decker[1:2]
to_plo_sub$value[which(to_plo_sub$variable == "Depthbar" & to_plo_sub$value >500)] <- NA
ylim.prim <- c(0,30)
ylim.sec <- c(-0.5,2)
b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1]
plo_agg_subfdom <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "fDOMRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_line(data = to_plo_sub[which(to_plo_sub$Station.Code %in% deckerOnly & (to_plo_sub$datetimestamp >= xdtsDeck2[1] & to_plo_sub$datetimestamp <= xdtsDeck2[2]) & to_plo_sub$variable == "Depthbar"),], aes(x = datetimestamp, y = 6 +value*12, colour = Station.Code), alpha = 0.3)+
  geom_point(alpha = 0.5) +
  scale_fill_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_color_manual(values = mycol[1:2],labels = c("Breach","Interior"))+ 
  scale_shape_manual(values = mysh[1:2],labels = c("Breach","Interior")) +
  scale_size_manual(values = myps[1:2],labels = c("Breach","Interior")) +
  scale_y_continuous(sec.axis = sec_axis(~(. - 6)/12, name = "Depth (m)")) +
  theme_classic() +
  #ylim(0,5) +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

sites <- c(yolo, decker)
p <- list()
for(i in seq_along(sites)){
  df <- agg_dat_subD[which(agg_dat_subD$Station.Code == sites[i]),]
  dfT95 <- aggregate(TempC ~ datetimestamp, data = df, FUN = quantile, probs  = 0.95)
  dfT95$qua <- c("pct95")
  dfT95$lt <- c("dotted")
  dfT50 <- aggregate(TempC ~ datetimestamp, data = df, FUN = quantile, probs  = 0.50)
  dfT50$qua <- c("median")
  dfT50$lt <- c("solid")
  dfT05 <- aggregate(TempC ~ datetimestamp, data = df, FUN = quantile, probs  = 0.05)
  dfT05$qua <- c("pct5")
  dfT05$lt <- c("dashed")
  dfD95 <- aggregate(DOmgL ~ datetimestamp, data = df, FUN = quantile, probs  = 0.95)
  dfD95$qua <- c("pct95")
  dfD95$lt <- c("dotted")
  dfD50 <- aggregate(DOmgL ~ datetimestamp, data = df, FUN = quantile, probs  = 0.50)
  dfD50$qua <- c("median")
  dfD50$lt <- c("solid")
  dfD05 <- aggregate(DOmgL ~ datetimestamp, data = df, FUN = quantile, probs  = 0.05)
  dfD05$qua <- c("pct5")
  dfD05$lt <- c("dashed")
  dfTu95 <- aggregate(Turb ~ datetimestamp, data = df, FUN = quantile, probs  = 0.95)
  dfTu95$qua <- c("pct95")
  dfTu95$lt <- c("dotted")
  dfTu50 <- aggregate(Turb ~ datetimestamp, data = df, FUN = quantile, probs  = 0.50)
  dfTu50$qua <- c("median")
  dfTu50$lt <- c("solid")
  dfTu05 <- aggregate(Turb ~ datetimestamp, data = df, FUN = quantile, probs  = 0.05)
  dfTu05$qua <- c("pct5")
  dfTu05$lt <- c("dashed")
  dfT <- rbind.data.frame(dfT95,dfT50,dfT05)
  dfT$variable <- "TempC"
  colnames(dfT)[2] <- c("value")
  dfT$Site <- sites[i]
  dfD <- rbind.data.frame(dfD95,dfD50,dfD05)
  dfD$variable <- "DOmgL"
  dfD$Site <- sites[i]
  colnames(dfD)[2] <- c("value")
  dfTu <- rbind.data.frame(dfTu95,dfTu50,dfTu05)
  dfTu$variable <- "Turb"
  colnames(dfTu)[2] <- c("value")
  dfTu$Site <- sites[i]
  p[[i]] <- rbind.data.frame(dfT,dfD,dfTu)
}
names(p) <- sites
to_plo2 <- do.call(rbind.data.frame, p)

xdtsDeck2 <- to_plo2$datetimestamp[which(to_plo2$Site == "Decker Breach")]
xdtsYolo2 <- to_plo2$datetimestamp[which(to_plo2$Site == "Yolo Flyway Farm")]

plo_stat <- ggplot(to_plo2[which(to_plo2$Site %in% yolo & to_plo2$datetimestamp %in% xdtsYolo2),], aes(x = datetimestamp, y = value, colour = Site, linetype = lt)) +
  geom_line() +
  facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() 



to_plo3 <- dcast(to_plo2,datetimestamp+Site+variable ~qua)
to_plo3$variable <- factor(to_plo3$variable, levels = c("TempC","DOmgL","Turb"), labels = c("Temperature (C)","Dissolved Oxygen (mg/L)","Turbidity (FNU)"))
plo_stat2 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  theme(axis.title.y = element_blank())

plo_stat2 <- ggplot(to_plo3[which(to_plo3$Site %in% yolo & to_plo3$datetimestamp %in% xdtsYolo2),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  theme(axis.title.y = element_blank())


### Feb21 to Mar16 had no sondes
skipS <- c(as.POSIXct(strptime(c('2020-02-21 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-12 04:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-21 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-12 04:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-21 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-12 04:00:00'),format = "%Y-%m-%d %H:%M")))
skipE <- c(as.POSIXct(strptime(c('2020-03-18 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-13 16:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-03-18 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-13 16:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-03-18 00:00:00'),format = "%Y-%m-%d %H:%M")),
           as.POSIXct(strptime(c('2020-02-13 16:00:00'),format = "%Y-%m-%d %H:%M")))
valmax <- c(23,23,12,12,400,400)#max(to_plo3$pct95[which(to_plo3$variable== "Temperature (C)")])
valmin <- c(5,5,5,5,0,0)#min(to_plo3$pct5[which(to_plo3$variable== "Temperature (C)")])
varSkip <- c("temp","temp","do","do","turb","turb")
dfBox <- data.frame(skipS,skipE,valmax,valmin, varSkip)

plo_stat4 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2 & to_plo3$variable=="Temperature (C)"),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  geom_hline(yintercept=25.4) + 
  geom_hline(yintercept=24, linetype="dashed") + 
  geom_rect(data = dfBox[which(dfBox$varSkip == "temp"),], aes(xmin = skipS, xmax = skipE, ymin = valmin, ymax = valmax),color = "white",fill="white")+
  scale_color_manual(values = mycol,labels = c("Pool","Breach","Channel")) +
  #scale_shape_manual(values = mysh,labels = c("Pool","Breach","Channel")) +
  #facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (C)") +
  #theme(axis.text.x =element_blank())+
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_stat5 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2 & to_plo3$variable=="Dissolved Oxygen (mg/L)"),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  geom_hline(yintercept=2.5) + 
  geom_hline(yintercept=4.6, linetype="dashed") + 
  geom_rect(data = dfBox[which(dfBox$varSkip == "do"),], aes(xmin = skipS, xmax = skipE, ymin = valmin, ymax = valmax),color = "white",fill="white")+
  scale_color_manual(values = mycol,labels = c("Pool","Breach","Channel")) +
  scale_shape_manual(values = mysh,labels = c("Pool","Breach","Channel")) +
  #facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  #theme(axis.text.x =element_blank())+
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_stat6 <- ggplot(to_plo3[which(to_plo3$Site %in% decker & to_plo3$datetimestamp %in% xdtsDeck2 & to_plo3$variable=="Turbidity (FNU)"),], aes(colour = Site)) +
  geom_line(aes(x = datetimestamp, y = median), linetype = c("dashed")) +
  geom_ribbon(aes(ymin = pct5, ymax = pct95, fill = Site,x = datetimestamp),alpha = 0.3) +
  geom_rect(data = dfBox[which(dfBox$varSkip == "turb"),], aes(xmin = skipS, xmax = skipE, ymin = valmin, ymax = valmax),color = "white",fill="white")+
  geom_hline(yintercept=12)+
  geom_hline(yintercept=80) + 
  scale_color_manual(values = mycol,labels = c("Pool","Breach","Channel")) +
  scale_shape_manual(values = mysh,labels = c("Pool","Breach","Channel")) +
  #facet_wrap(~ variable, ncol = 1, scales = 'free_y') + 
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  #theme(axis.text.x =element_blank())+
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

```


For Yolo
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

df <- df[which(df$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("TOE_USGS","LIB_USGS") & 
                       dfAll$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU")]
dat[,10:11] <- as.numeric(NA)
colnames(dat)[10:11] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:11] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,11,8,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)
dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")




dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','fDOMRFU','fdomConc','PCRFU'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU),
               #Chlconcbar = mean(Chlconc),
               fDOMRFUbar = mean(fDOMRFU),
               fDOMconcbar = mean(fdomConc),
               PCbar = mean(PCRFU)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Yolo Flyway Farm","TOE_USGS","LIB_USGS"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]


unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","TOE_USGS","LIB_USGS")
decker <- c("Decker Breach","Decker Pool","SDI_USGS")

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Breach")]
xdtsYolo <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Yolo Flyway Farm")]
xdtsYolo2 <- range(xdtsYolo)


mycol <- (viridis_pal(option = "H")(56))[c(44,24,33)]
mycol[3] <- c("black")
mysh <- c(21,25,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)


to_plo_sub2 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "Yolo Flyway Farm"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "TOE_USGS"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "LIB_USGS"),])

plo_agg_subT <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "Tempbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

### shape for breach is 4, shape for pool is 24, use circle 20 for channel

plo_agg_subDO <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "DObar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subSPC <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "SPCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Specific Conductivity (\u00B5S/cm)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


plo_agg_subTu <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% yolo & to_plo_sub2$datetimestamp %in% xdtsYolo & to_plo_sub2$variable == "Turbbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=12, linetype = "dashed")+
  geom_hline(yintercept=80) +
  scale_fill_manual(values = mycol, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh, labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps, labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

pl2 <- plo_agg_subTu + annotation_custom(grob = ggplotGrob(plo_agg_subTu +ylim(0,100) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-05-15",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2021-11-30",format = "%Y-%m-%d")), 
                                         ymin = 175, ymax = 400)


plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yolo & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol,labels = c("Flyway","Toe Drain","Liberty")) +
  scale_shape_manual(values = mysh,labels = c("Flyway","Toe Drain","Liberty")) +
  scale_size_manual(values = myps,labels = c("Flyway","Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

yoloOnly <- yolo[1]
plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp >= xdtsYolo2[1] & to_plo_sub$datetimestamp <= xdtsYolo2[2] & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1],labels = c("Flyway"))+ 
  scale_shape_manual(values = mysh[1],labels = c("Flyway")) +
  scale_size_manual(values = myps[1],labels = c("Flyway")) +
  ylim(0,15) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <-plo_agg_subChl + annotation_custom(grob = ggplotGrob(plo_agg_subChl +ylim(0,42) + 
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-03-07",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2022-01-10",format = "%Y-%m-%d")), 
                                         ymin = 8, ymax = 15)


toed <- yolo[2:3]
plo_agg_subChlToe <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% toed & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[2:3],labels = c("Toe Drain","Liberty"))+ 
  scale_shape_manual(values = mysh[2:3],labels = c("Toe Drain","Liberty")) +
  scale_size_manual(values = myps[2:3],labels = c("Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (\u00B5g/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(pl2, plo_agg_subChlToe,nrow = 2), ncol =1)

yoloOnly <- yolo[1]
plo_agg_subPC <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp >= xdtsYolo2[1] & to_plo_sub$datetimestamp <= xdtsYolo2[2] & to_plo_sub$variable == "PCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1],labels = c("Flyway"))+ 
  scale_shape_manual(values = mysh[1],labels = c("Flyway")) +
  scale_size_manual(values = myps[1],labels = c("Flyway")) +
  ylim(0,3) +
  theme_classic() +
  xlab("Date") +
  ylab("Phycocyanin (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
pl2 <-plo_agg_subPC + annotation_custom(grob = ggplotGrob(plo_agg_subPC  + ylim(0,42) +
                                                             theme(axis.title = element_blank(),
                                                                   legend.position = "none")),
                                         xmin = as.POSIXct(strptime("2021-03-07",format = "%Y-%m-%d")),
                                         xmax = as.POSIXct(strptime("2022-01-10",format = "%Y-%m-%d")), 
                                         ymin = 2, ymax = 3)

yoloOnly <- yolo[1]
plo_agg_subfdom <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% yoloOnly & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "fDOMRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1],labels = c("Flyway     "))+ 
  scale_shape_manual(values = mysh[1],labels = c("Flyway     ")) +
  scale_size_manual(values = myps[1],labels = c("Flyway     ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


toed <- yolo[2:3]
plo_agg_subfdomtoe <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% toed & to_plo_sub$datetimestamp %in% xdtsYolo & to_plo_sub$variable == "fDOMconcbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[2:3],labels = c("Toe Drain","Liberty"))+ 
  scale_shape_manual(values = mysh[2:3],labels = c("Toe Drain","Liberty")) +
  scale_size_manual(values = myps[2:3],labels = c("Toe Drain","Liberty")) +
  theme_classic() +
  xlab("Date") +
  ylab("Fluorescent Dissolved\nOrganic Matter (mg/L as QSE)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subfdom, plo_agg_subfdomtoe,nrow = 2), ncol =1)

```

For 2021 Tule Red data collected by DWR
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)

rm(list = ls())

dfTR <- data.frame(read.csv("TRB_2021_data.csv"))

unique(dfTR$qaqc_flag_id)
dfTR2 <- dfTR[which(dfTR$qaqc_flag_id == "G"),]
dfTR2$dts <- as.POSIXct(strptime(dfTR2$time, format = "%m/%d/%Y %H:%M"))


dfTR3 <- dfTR2[which(dfTR2$dts >= as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")) & 
                       dfTR2$dts <= as.POSIXct(strptime("2021-12-31 23:45", format = "%Y-%m-%d"))),
               c(6,5,2)]


dfTR4 <- reshape2::dcast(dfTR2, dts ~ analyte_name, value.var = "value")
colnames(dfTR4) <- c("dts","ChlRFU","DOmgL","pH","SPC","Turb","TempC")

dfTR4$Site <- "TuleRed"

xdtsTule <- range(dfTR4$dts)
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("Grizzly_USGS") & #,"Grizzly_CDEC", "GrizzlyL_CDEC" ###DMC: going to use only Grizzly_USGS
                       dfAll$dts >= as.POSIXct(strptime(xdtsTule[1], format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime(xdtsTule[2], format = "%Y-%m-%d"))),]

dat <- dfTR4[,c("Site","dts","TempC","SPC","pH","Turb","DOmgL","ChlRFU")]


#dfAll <- dfAll[,-5]
dfAll <- dfAll[,c("site","dts","temp","sc","ph","turb","do","chl")]
colnames(dfAll) <- colnames(dat)

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")




dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','pH','Turb','DOmgL','ChlRFU'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               pHbar = mean(pH),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU)
               #Chlconcbar = mean(Chlconc),
               #fDOMRFUbar = mean(fDOMRFU),
               #fDOMconcbar = mean(fdomConc),
               #PCbar = mean(PCRFU)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("TuleRed","Grizzly_USGS"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]


unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","TOE_USGS","LIB_USGS")
decker <- c("Decker Breach","Decker Pool","SDI_USGS")
tule <- c("TuleRed","Grizzly_USGS")

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Breach")]
xdtsYolo <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Yolo Flyway Farm")]
xdtsYolo2 <- range(xdtsYolo)


mycol <- (viridis_pal(option = "H")(56))[c(44,24,33)]
#mycol[3] <- c("black")
mysh <- c(21,25,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)


to_plo_sub2 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "TuleRed"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "Grizzly_USGS"),])



plo_agg_subT <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% tule & to_plo_sub2$variable == "Tempbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

### shape for breach is 4, shape for pool is 24, use circle 20 for channel

plo_agg_subDO <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% tule & to_plo_sub2$variable == "DObar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Dissolved Oxygen (mg/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subPH <- ggplot(to_plo_sub2[which(to_plo_sub2$Station.Code %in% tule & to_plo_sub2$variable == "pHbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("pH") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

to_plo_sub3 <- rbind.data.frame(to_plo_sub[which(to_plo_sub$Station.Code == "Grizzly_USGS"),],
                                to_plo_sub[which(to_plo_sub$Station.Code == "TuleRed"),])
plo_agg_subSPC <- ggplot(to_plo_sub3[which(to_plo_sub3$Station.Code %in% tule & to_plo_sub3$variable == "SPCbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Specific Conductivity (\u00B5S/cm)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


plo_agg_subTu <- ggplot(to_plo_sub3[which(to_plo_sub3$Station.Code %in% tule & to_plo_sub3$variable == "Turbbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.7, colour = "black") +
  geom_hline(yintercept=12, linetype = "dashed")+
  geom_hline(yintercept=80) +
  scale_fill_manual(values = mycol[1:2], labels = c("Tule Red","Grizzly")) +
  scale_shape_manual(values = mysh[1:2], labels = c("Tule Red","Grizzly")) +
  scale_size_manual(values = myps[1:2], labels = c("Tule Red","Grizzly")) +
  theme_classic() +
  xlab("Date") +
  ylab("Turbidity (FNU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())


tuleOnly <- tule[1]
plo_agg_subChl <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% tuleOnly & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[1], labels = c("Tule Red")) +
  scale_shape_manual(values = mysh[1], labels = c("Tule Red")) +
  scale_size_manual(values = myps[1], labels = c("Tule Red")) +
  scale_y_continuous(breaks = pretty_breaks(n = 5)) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (RFU)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())



griz <- tule[2]
plo_agg_subChlToe <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% griz & to_plo_sub$variable == "ChlRFUbar"),], aes(x = datetimestamp, y = value, fill = Station.Code, shape = Station.Code, size = Station.Code)) +
  geom_point(alpha = 0.5, colour = "black") +
  scale_fill_manual(values = mycol[2], labels = c("Grizzly    ")) +
  scale_shape_manual(values = mysh[2], labels = c("Grizzly    ")) +
  scale_size_manual(values = myps[2], labels = c("Grizzly    ")) +
  theme_classic() +
  xlab("Date") +
  ylab("Chlorophyll a (\u00B5g/L)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subChl, plo_agg_subChlToe,nrow = 2), ncol =1)
```



Time-series Decomposition For Decker
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(df$Site)
unique(dfAll$site)

df <- df[which(df$dts >= as.POSIXct(strptime("2021-07-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Decker Pool" ),]

df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

df[which(df$dts == "2021-07-30 10:18:04" | df$dts == "2021-07-30 10:33:04"),c(6:14)] <- NA
df$Depthm[which(df$dts == "2021-07-03 21:24:18")] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too


unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("M13_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-09-10 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11:12] <- as.numeric(NA)
colnames(dat)[11:12] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:12] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,8,11,12,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)

dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(unique(Time))) # 96 measurements per day... pTime = sum(frac/4656)*96

dfDeck <- dat3[which(dat3$Station.Code == "Decker Pool" & 
                       dat3$datetimestamp >= as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")) & 
                       dat3$datetimestamp <= as.POSIXct(strptime("2021-09-09 23:45", format = "%Y-%m-%d"))),]
dfM13 <- dat3[which(dat3$Station.Code == "M13_USGS" & dat3$Date != "2021-07-31"),]
dfM13[which(dfM13$datetimestamp >= as.POSIXct(strptime("2021-08-23 22:45:00",format = "%Y-%m-%d %H:%M:%S")) &
              dfM13$datetimestamp <= as.POSIXct(strptime("2021-08-23 23:30:00",format = "%Y-%m-%d %H:%M:%S"))),"TempC"] <- 20.0

dfDeck$day <- as.integer(factor(dfDeck$Date, levels = unique(dfDeck$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),40))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13 <- dfM13[-3841,]
dfM13$frac <- as.integer(rep(c(1:96),40))

deck_ts <- ts(data = dfDeck$TempC,
              start = c(dfDeck$day[1], dfDeck$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfM13$TempC,
              start = c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder

#deck.mat <-c(matrix(data = dfDeck$TempC, ncol = length(dfDeck$TempC), nrow = 96, byrow = TRUE))
#deck.ts <- ts(deck.mat, frequency = 96)
#deck.decomp <- decompose(deck.ts)
#autoplot(deck.decomp) + xlab("Year") + ggtitle("Classical Additive Decomposition of Decker Temperature")

autoplot(deck_mst1) + xlab("Year") + ggtitle("STL Decomposition of Electrical Equipment Index")
hist(deck_mst1[,"Remainder"])
#hist(deck_st1$data[,"remainder"])

#plot.frequency.spectrum <- function(X.k, xlimits=c(0,length(X.k))) {
#  plot.data  <- cbind(0:(length(X.k)-1), Mod(X.k))

  # TODO: why this scaling is necessary?
#  plot.data[2:length(X.k),2] <- 2*plot.data[2:length(X.k),2] 
#  
#  plot(plot.data, t="h", lwd=2, main="", 
#       xlab="Frequency (Hz)", ylab="Strength", 
#       xlim=xlimits, ylim=c(0,max(Mod(plot.data[,2]))))
#}
#X.k <- fft(deck_mst1[,"Remainder"])
#plot.frequency.spectrum(X.k,xlimits=c(0,acq.freq/2))

################################################################################
### for deck
plot(deck_mst1[,"Remainder"])
f.data <- GeneCycle::periodogram(deck_mst1[,"Remainder"])
harmonics <- 1:96
plot(f.data$freq[harmonics]*length(deck_mst1[,"Remainder"]), 
     f.data$spec[harmonics]/sum(f.data$spec), 
     xlab="Harmonics (Hz)", ylab="Amplitute Density", type="h")

f.data2 <- data.frame(freq = as.numeric(f.data$freq),
                      spec = as.numeric(f.data$spec))
f.data2$period.hr <- (1/f.data2$freq)*15/60
f.data2$freq.hr <- 1/f.data2$period.hr
plot(f.data2$period.hr[which(f.data2$period.hr < 100)], f.data2$spec[which(f.data2$period.hr < 100)], type = "h")

library(psdr)
Fs <- 1/(15*60) # 15 minutes times 60 seconds per 1 minute is 900 seconds, so frequency is 1 per 900 seconds or 0.001111 Hz
results <- MakePowerSpectralDensity(Fs,deck_mst1[,"Remainder"])
frequencies <- results[[1]]
PSD <- results[[2]]
p.data2 <- data.frame(frequencies, PSD)
p.data2$period.hr <- (1/p.data2$frequencies) * (1/60) * (1/60)
plot(frequencies[-1], PSD[-1], type = "l")
plot(p.data2$period.hr[which(p.data2$period.hr < 100)], p.data2$PSD[which(p.data2$period.hr < 100)], type = "h")
################################################################################


################################################################################
### for sacr
plot(sacr_mst1[,"Remainder"])
f.data <- GeneCycle::periodogram(sacr_mst1[,"Remainder"])
harmonics <- 1:96
plot(f.data$freq[harmonics]*length(deck_mst1[,"Remainder"]), 
     f.data$spec[harmonics]/sum(f.data$spec), 
     xlab="Harmonics (Hz)", ylab="Amplitute Density", type="h")

f.data2sacr <- data.frame(freq = as.numeric(f.data$freq),
                      spec = as.numeric(f.data$spec))
f.data2sacr$period.hr <- (1/f.data2sacr$freq)*15/60
f.data2sacr$freq.hr <- 1/f.data2sacr$period.hr
plot(f.data2sacr$period.hr[which(f.data2sacr$period.hr < 100)], f.data2sacr$spec[which(f.data2sacr$period.hr < 100)], type = "h")

library(psdr)
Fs <- 1/(15*60) # 15 minutes times 60 seconds per 1 minute is 900 seconds, so frequency is 1 per 900 seconds or 0.001111 Hz
results <- MakePowerSpectralDensity(Fs,sacr_mst1[,"Remainder"])
frequencies <- results[[1]]
PSD <- results[[2]]
p.data2sacr <- data.frame(frequencies, PSD)
p.data2sacr$period.hr <- (1/p.data2sacr$frequencies) * (1/60) * (1/60)
plot(frequencies[-1], PSD[-1], type = "l")
plot(p.data2sacr$period.hr[which(p.data2sacr$period.hr < 100)], p.data2sacr$PSD[which(p.data2sacr$period.hr < 100)], type = "h")
################################################################################

p.data2$psd2 <- p.data2$PSD/sum(p.data2$PSD)
p.data2sacr$psd2 <- p.data2sacr$PSD/sum(p.data2sacr$PSD)
psd.comp <- ggplot(data = p.data2[which(p.data2$period.hr < 50 & p.data2$psd2 > 0.001),], aes(x = period.hr, y = log10(psd2))) +
  geom_point(color = "blue") +
  geom_point(data = p.data2sacr[which(p.data2sacr$period.hr < 50& p.data2sacr$psd2 > 0.001),], color = "red")


to_plo_sub <- rbind.data.frame(dfDeck, dfM13)
#to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Decker Pool", "M13_USGS"))

mycol <- (viridis_pal(option = "H")(56))[c(24,44)]
#mycol[3] <- c("black")
mysh <- c(25,21)
myps <- c(1.5,1.3)
myalf <- c(0.5,1)

xdtsJuly <- c(as.POSIXct(strptime("2021-07-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsJuly[1] &  to_plo_sub$datetimestamp <= xdtsJuly[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))

plo_agg_Trend <- ggplot(to_plo_sub, aes(x = datetimestamp, y = seas_adj, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = TempC, color = Station.Code)) +
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = trend, alpha = Station.Code), color = "black") +
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 20, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  scale_color_manual(values = mycol,labels = c("Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

dat3 <- swmpr(dat3, meta_in = FALSE)
attr(dat3,'timezone')<-"UTC"

agg_dat_sub <- aggreswmp(dat3, by = 'hours', 
                         params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','fDOMRFU','fdomConc','PCRFU','Depthm'), aggs_out = T)
  #params = c('Station.Code','TempC','SPC','Turb','DOmgL','ChlRFU','Chlconc','fDOMRFU','fDOMconc','PCRFU'), aggs_out = T)

summH <- ddply(agg_dat_sub, c("Station.Code","datetimestamp"), summarise,
               Tempbar = mean(TempC),
               SPCbar = mean(SPC),
               Turbbar = mean(Turb),
               DObar = mean(DOmgL),
               ChlRFUbar = mean(ChlRFU),
               #Chlconcbar = mean(Chlconc),
               fDOMRFUbar = mean(fDOMRFU),
               fDOMconcbar = mean(fdomConc),
               PCbar = mean(PCRFU),
               Depthbar = mean(Depthm)
               )
agg_dat_sub <- summH

to_plo_sub <- melt(agg_dat_sub, id.var = c('Station.Code','datetimestamp'))
to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Decker Breach", "Decker Pool", "M13_USGS"))#, "SacSherman_CDEC", "SDI_USGS", "Emmaton_CDEC"
                                  #labels = c("P","B","S","Y","T"))
to_plo_sub <- to_plo_sub[which(is.na(to_plo_sub$datetimestamp)==FALSE),]

to_plo_sub$ord <- as.numeric(to_plo_sub$Station.Code)
to_plo_sub <- to_plo_sub[order(to_plo_sub$ord),]

unique(to_plo_sub$Station.Code)
yolo <- c("Yolo Flyway Farm","Toe Drain")
decker <- c("Decker Breach","Decker Pool","M13_USGS") # ,"SacSherman_CDEC" has info #,"SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data

xdtsDeck <- to_plo_sub$datetimestamp[which(to_plo_sub$Station.Code == "Decker Pool" | to_plo_sub$Station.Code == "Decker Breach")]
xdtsDeck2 <- range(xdtsDeck)

mycol <- (viridis_pal(option = "H")(56))[c(24,44,33)]
mycol[3] <- c("black")
mysh <- c(25,21,21)
myps <- c(1.5,1.3,1)
myalf <- c(0.5,0.5,0.7)

xdtsSpring1 <- c(as.POSIXct(strptime("2021-04-19 00:00", format = "%Y-%m-%d")),
                 as.POSIXct(strptime("2021-05-10 00:00", format = "%Y-%m-%d")))
xdtsSpring2 <- c(as.POSIXct(strptime("2021-01-01 00:00", format = "%Y-%m-%d")),
                 as.POSIXct(strptime("2021-05-30 00:00", format = "%Y-%m-%d")))
xdtsJune <- c(as.POSIXct(strptime("2021-06-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-06-30 00:00", format = "%Y-%m-%d")))
xdtsJuly <- c(as.POSIXct(strptime("2021-07-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-07-31 00:00", format = "%Y-%m-%d")))
xdtsAug <- c(as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-08-30 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))


plo_agg_subTsub <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2] & to_plo_sub$variable == "Tempbar"),], aes(x = datetimestamp, y = value, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  scale_color_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

plo_agg_subDep <- ggplot(to_plo_sub[which(to_plo_sub$Station.Code %in% decker & to_plo_sub$datetimestamp >= xdtsAug[1] &  to_plo_sub$datetimestamp <= xdtsAug[2] & to_plo_sub$variable == "Depthbar"),], aes(x = datetimestamp, y = value, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  #geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  #geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 0, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  ylim(-0.1,1.5) +
  scale_color_manual(values = mycol,labels = c("Breach","Interior","Sacramento\nRiver")) + 
  scale_shape_manual(values = mysh,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_size_manual(values = myps,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_alpha_manual(values = myalf,labels = c("Breach","Interior","Sacramento\nRiver")) +
  scale_fill_manual(values = c("white","black"),labels = c("Full","New")) + 
  theme_classic() +
  xlab("Date") +
  ylab("Depth (m)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())

gridExtra::grid.arrange(arrangeGrob(plo_agg_subTsub, plo_agg_subDep,nrow = 2), ncol =1)
```


Time-series Decomposition For Flyway
Saving figures to "C:\Users\DCox\OneDrive - California Department of Fish and Wildlife\Documents\FRP\Monitoring\Reports\2021SiteReports"
```{r}
library(SWMPr)
library(ggplot2)
library(reshape2)
library(viridis)
library(plyr)
library(scales)
library(gridExtra)
library(suncalc)

rm(list = ls())


load("FRP_LTMsonde_220526.RData")
load("ExtLTM_CompleteMerge.RData") ###DMC220601: this is a huge file with all data from every nearby sonde

unique(df$Site)

df <- df[which(df$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                 df$dts <= as.POSIXct(strptime("2021-08-31 23:45", format = "%Y-%m-%d")) &
                 df$Site == "Yolo Flyway Farm" ),]

df$Turb[which(df$Turb > 1000)] <- NA ###DMC220713: Turbidity sensor is only rated up to 1000 so any values above it must be discarded. The high calibration standard used is ~100 so any values above that are suspect
df[which(df$TempC == 0), 6:15] <- NA

#df[which(df$dts == "2021-07-30 10:18:04" | df$dts == "2021-07-30 10:33:04"),c(6:14)] <- NA
#df$Depthm[which(df$dts == "2021-07-03 21:24:18")] <- NA

df$ChlRFU[which(df$ChlRFU > 100)] <- NA ###DMC220713: Chl sensor is only rated up to 100 RFU so any values above it must be discarded.
df$PCRFU[which(df$PCRFU > 100 | df$PCRFU < 0)] <- NA ###DMC220713: Phycocyanin sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too
df$fDOMRFU[which(df$fDOMRFU < 0)] <- NA ###DMC220713: FDOM sensor is only rated up to 100 RFU so any values above it must be discarded. Any values below 0 must be discarded too


unique(dfAll$site)
dfAll <- dfAll[which(dfAll$site %in% c("TOE_USGS") & # "SacSherman_CDEC", "SDI_USGS","Emmaton_CDEC" ###DMC220713: these stations did not have data
                       dfAll$dts >= as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")) & 
                       dfAll$dts <= as.POSIXct(strptime("2021-08-31 23:45", format = "%Y-%m-%d"))),]

dat <- df[,c("Site","dts","TempC","SPC","Turb","DOmgL","ChlRFU","PCRFU","fDOMRFU","Depthm")]
dat[,11:12] <- as.numeric(NA)
colnames(dat)[11:12] <- c("fdomConc","velocity")

dfAll <- dfAll[,-5]
dfAll[,10:12] <- as.numeric(NA)
dfAll <- dfAll[,c(1:7,10,8,11,12,9)]
colnames(dfAll) <- colnames(dat)

dfAll$ChlRFU <- as.numeric(dfAll$ChlRFU)
dfAll$PCRFU <- as.numeric(dfAll$PCRFU)
dfAll$fDOMRFU <- as.numeric(dfAll$fDOMRFU)

dfAll$ChlRFU[which(dfAll$ChlRFU > 400)] <- NA ###DMC220713: Chl sensor is only rated up to 400 ug/L so any values above it must be discarded.

dat3 <- rbind.data.frame(dat,dfAll)
colnames(dat3)[1:2] <- c("Station.Code","datetimestamp")

dat3$Date <- substr(as.character(dat3$datetimestamp),0,10)
dat3$Time <- substr(as.character(dat3$datetimestamp),12,19)

?decompose
summTime <- ddply(dat3, c("Station.Code","Date"), summarise,
               nTime = length(Time)) # 96 measurements per day

dfDeck <- dat3[which(dat3$Station.Code == "Yolo Flyway Farm"),]
dfM13 <- dat3[which(dat3$Station.Code == "TOE_USGS" & dat3$Date != "2021-08-31"),]

dfDeck$day <- as.integer(factor(df$Date, levels = unique(df$Date)))
dfDeck$frac <- as.integer(rep(c(1:96),30))

dfM13$day <- as.integer(factor(dfM13$Date, levels = unique(dfM13$Date)))
dfM13$frac <- as.integer(rep(c(1:96),30))

deck_ts <- ts(data = dfDeck$TempC,
              start = c(dfDeck$day[1], dfDeck$frac[1]),
              frequency = 96)
deck_st1 <- stlplus::stlplus(deck_ts, s.window = "periodic")
plot(deck_st1)
deck_mst1 <- forecast::mstl(deck_ts, lambda = NULL)
plot(deck_mst1)

sacr_ts <- ts(data = dfM13$TempC,
              start = c(dfM13$day[1], dfM13$frac[1]),
              frequency = 96)
sacr_st1 <- stlplus::stlplus(sacr_ts, s.window = "periodic")
plot(sacr_st1)
sacr_mst1 <- forecast::mstl(sacr_ts, lambda = NULL)
plot(sacr_mst1)
sacr_mst1_auto <- forecast::mstl(sacr_ts, lambda = "auto")
plot(sacr_mst1_auto)

dfDeck$trend <- as.numeric(deck_mst1[,"Trend"])
dfDeck$remainder <- as.numeric(deck_mst1[,"Remainder"])
dfDeck$seas_adj <- dfDeck$trend + dfDeck$remainder
dfM13$trend <- as.numeric(sacr_mst1[,2])
dfM13$remainder <- as.numeric(sacr_mst1[,"Remainder"])
dfM13$seas_adj <- dfM13$trend + dfM13$remainder

to_plo_sub <- rbind.data.frame(dfDeck, dfM13)
#to_plo_sub$dts <- as.POSIXct(strptime(as.character(to_plo_sub$datetimestamp),format = "%Y-%m-%d"))
to_plo_sub$Station.Code <- factor(to_plo_sub$Station.Code, levels = c("Yolo Flyway Farm", "TOE_USGS"))

mycol <- (viridis_pal(option = "H")(56))[c(24,44)]
#mycol[3] <- c("black")
mysh <- c(25,21)
myps <- c(1.5,1.3)
myalf <- c(0.5,1)

xdtsJuly <- c(as.POSIXct(strptime("2021-08-01 00:00", format = "%Y-%m-%d")),
              as.POSIXct(strptime("2021-08-31 00:00", format = "%Y-%m-%d")))

dates4sun <- unique(as.Date(to_plo_sub$datetimestamp[which(to_plo_sub$datetimestamp >= xdtsJuly[1] &  to_plo_sub$datetimestamp <= xdtsJuly[2])]))

suntimes <- getSunlightTimes(date = as.Date(dates4sun), lat = 38.086880, lon = -121.719738,
                             keep = c("sunrise","sunset","goldenHour","goldenHourEnd"),
                             tz = "America/Los_Angeles")
suntimes2 <- data.frame(suntimes$date[1:length(suntimes$date)-1],suntimes$sunset[1:length(suntimes$date)-1],suntimes$sunrise[2:length(suntimes$date)])
colnames(suntimes2) <- c("date","sunset","sunrise")

moonphase <- getMoonIllumination(date = as.Date(dates4sun),
                                 keep = c("fraction","phase"))
moonphase$date2 <- as.POSIXct(strptime(moonphase$date, format = "%Y-%m-%d"))
moonphase2 <- data.frame(moonphase$date[which.max(moonphase$fraction)], moonphase$fraction[which.max(moonphase$fraction)], "Full")
moonphase2[2,] <- data.frame(moonphase$date[which.min(moonphase$fraction)], moonphase$fraction[which.min(moonphase$fraction)], "New")
colnames(moonphase2) <- c("date","fraction","phase")
moonphase2$date2 <- as.POSIXct.Date(moonphase2$date)
moonphase2$phase2 <- factor(moonphase2$phase, levels = c("Full","New"))

plo_agg_Trend <- ggplot(to_plo_sub, aes(x = datetimestamp, y = seas_adj, color = Station.Code, alpha = Station.Code, shape = Station.Code, size = Station.Code)) + 
  geom_line() +#, shape = 21
  geom_hline(yintercept=25.4) + ###DMC: "Swanson C, Reid T, Young PS, Cech Jr JJ. 2000. Comparative environmental tolerances of threatened delta smelt (Hypomesus transpacificus) and introduced Wakasagi (H. nipponensis) in an altered California estuary. Oecologia 123(3):384-390
  geom_hline(yintercept=24, linetype="dashed") + ###DMC: reference is "Rich A.A. (1987). Report on studies conducted by Sacramento County to determine the temperatures which optimize growth and survival in juvenile chinook salmon (Onchorhynchus tshawwytscha). McDonough, Holland, & Allen, Sacramento, CA"
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = TempC, color = Station.Code)) +
  geom_line(data = to_plo_sub, inherit.aes = FALSE, aes(x = datetimestamp, y = trend, alpha = Station.Code), color = "black") +
  geom_rect(data = suntimes2, inherit.aes = FALSE, aes(xmin = sunset, xmax = sunrise, ymin = -Inf, ymax = Inf),
            fill = "gray", alpha = 0.1) +
  geom_point(data = moonphase2, aes(x = date2, y = 20, fill = phase2),
              inherit.aes = FALSE,
             size = 4, shape = 21, color = "black") +
  scale_color_manual(values = mycol,labels = c("Flyway","Toe\nDrain")) + 
  scale_shape_manual(values = mysh,labels = c("Flyway","Toe\nDrain")) +
  scale_size_manual(values = myps,labels = c("Flyway","Toe\nDrain")) +
  scale_alpha_manual(values = myalf,labels = c("Flyway","Toe\nDrain")) +
  theme_classic() +
  xlab("Date") +
  ylab("Temperature (\u00b0C)") +
  theme(axis.text.x =element_text(),
        axis.title = element_text(face = "bold"),
        legend.title = element_blank())
```