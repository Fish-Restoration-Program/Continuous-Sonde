---
title: "FRP_ContinuousWQ_SondeWorksheets"
author: "DMC"
date: "6/23/2023"
output: html_document
---

The goal of this file is to import worksheets from Survey123 and make RData files to use in the Processing script

First, we'll import the Exchange Worksheets and their crosswalk (these were generated using the first version of the CDFW Survey123 e-forms)
```{r}
rm(list = ls())

# read in the crosswalk file for renaming columns of raw Survey123 export file (Must make sure version matches)
cw_Exch <- data.frame(read.csv(here::here("raw","Survey123", "Exchanges230630_ColumnCrosswalk.csv")))

# read in the export frile from Survey123
df_Exch <- data.frame(read.csv(here::here("raw","Survey123", "Exchanges230630_Export230703.csv")))

# rename the columns of the export data
colnames(df_Exch) <- cw_Exch$Var_Name

# make a date variable that is in local timezone
df_Exch$date2 <- as.Date(format(lubridate::mdy_hms(df_Exch$exchange_date), tz = "UTC"))


### make datetime variable for the individual measurements
# first, we will subset all columns with time in name
df_ExchTimes <- df_Exch[,stringr::str_detect(colnames(df_Exch), "_time")]
# attach the new date object to subset
df_ExchTimes2 <- cbind(df_ExchTimes, data.frame(date2 = df_Exch$date2))
# make a blank version of subset to repopulate with datetime objects
df_ExchTimes3 <- df_ExchTimes
df_ExchTimes3[,] <- NA
# populate blank version of subset with newly created datetime objects
for(i in 1:ncol(df_ExchTimes3)){
  df_ExchTimes3[,i] = as.POSIXct(strptime(paste(as.character(df_ExchTimes2[,"date2"]),df_ExchTimes[,i],sep = " "), format = "%Y-%m-%d %H:%M"), tz = "UTC")
}
# populate the original exchange dataset with the newly created datetime objects
for(i in 1:ncol(df_ExchTimes3)){
  for(j in 1:ncol(df_Exch)){
    if(colnames(df_ExchTimes3)[i] == colnames(df_Exch)[j]){
      df_Exch[,j] = df_ExchTimes3[,i]
    }
  }
}

# make simple subsets of deployment/recovery times. These will be used for trimming datasets based on time
df_DeployTimes <- df_Exch[,c("station","date2","deployed_sonde_id","deployment_start_time","departure_time")]
df_RecoveryTimes <- df_Exch[,c("station","date2","recovered_sonde_id","recovery_stop_time","arrival_time")]
df_Times <- df_Exch[,c("station","date2","deployed_sonde_id","deployment_start_time","departure_time","recovered_sonde_id","recovery_stop_time","arrival_time")]

df_TimesLong <- rbind.data.frame(data.frame(action = c("Recovered"),
                                            sondeID = df_RecoveryTimes$recovered_sonde_id,
                                            timeX = df_RecoveryTimes$arrival_time,
                                            dateX = df_RecoveryTimes$date2),
                                 data.frame(action = c("Deployed"),
                                            sondeID = df_DeployTimes$deployed_sonde_id,
                                            timeX = df_DeployTimes$departure_time,
                                            dateX = df_DeployTimes$date2)
                                 )
df_TimesLong$sonde_date <- paste(df_TimesLong$sondeID,
                                 df_TimesLong$dateX,
                                 sep = " ")
# make a new variable to match with the raw data in downstream processes

df_DeployTimes$sonde_dateDeploy <- paste(df_DeployTimes$deployed_sonde_id,
                                   df_DeployTimes$date2,
                                   sep = " ")
df_RecoveryTimes$sonde_dateRecov <- paste(df_RecoveryTimes$recovered_sonde_id,
                                     df_RecoveryTimes$date2,
                                     sep = " ")

# force date change of recovery date for the two deployments since the battery died prior to recovery. This step allows for further matching downstream
df_RecoveryTimes$date2[which(df_RecoveryTimes$station == "FLYW_Bifurcation" & df_RecoveryTimes$recovered_sonde_id == "19C101554" & as.character(df_RecoveryTimes$date2) == "2022-09-22")] <- as.Date("2022-08-21", format = "%Y-%m-%d")
df_RecoveryTimes$date2[which(df_RecoveryTimes$station == "FLYW_Bifurcation" & df_RecoveryTimes$recovered_sonde_id == "19C101551" & as.character(df_RecoveryTimes$date2) == "2022-10-24")] <- as.Date("2022-10-23", format = "%Y-%m-%d")
# force date change of recovery date for the two deployments since the battery died prior to recovery. This step allows for further matching downstream
df_Exch$date2[which(df_Exch$station == "FLYW_Bifurcation" & df_Exch$recovered_sonde_id == "19C101554" & as.character(df_Exch$date2) == "2022-09-22")] <- as.Date("2022-08-21", format = "%Y-%m-%d")
df_Exch$date2[which(df_Exch$station == "FLYW_Bifurcation" & df_Exch$recovered_sonde_id == "19C101551" & as.character(df_Exch$date2) == "2022-10-24")] <- as.Date("2022-10-23", format = "%Y-%m-%d")

#testTime <- data.frame(origTime = df_Exch$exchange_date, newTime = NA)
#testTime$newTime <- lubridate::mdy_hms(testTime$origTime)
#testTime$pacTime <- format(testTime$newTime, tz = "UTC")
#testTime$pacDate <- as.Date(testTime$pacTime)

# save the exchange times for use in 'ContinuousSonde_Processing.Rmd'
save(df_DeployTimes, df_RecoveryTimes, file = here::here("working","CDFW_ExchangeTimes.RData"))
# save the exchange worksheet for use in 'ErrorCalculations.Rmd'
save(df_Exch, file = here::here("working","CDFW_ExchangeWorksheet.RData"))
```

Now, let's import the Calibration Worksheets and their crosswalk (these were generated using the first version of the CDFW Survey123 e-forms)
```{r}
rm(list = ls())
'%ni%' = Negate('%in%')
cw_Calib <- data.frame(read.csv(here::here("raw","Survey123", "Calibration230612_ColumnCrosswalk.csv")))
df_Calib <- data.frame(read.csv(here::here("raw","Survey123", "Calibration230612_Export230706.csv")))
colnames(df_Calib) <- cw_Calib$Var_Name

# make a datetime object for the deployment start/stop time
df_Calib$dts_startstop <- format(lubridate::mdy_hms(df_Calib$deployment_startstop_time), tz = "UTC")

# make 2 separate dataframes (1 with just the data we are interested and 1 with the metadata)
df_CalibData <- df_Calib[,c("GlobalID","sonde_id","sonde_other","discrete_or_continuous","pre_post","dts_startstop",colnames(df_Calib)[53:95])]
df_CalibMeta <- df_Calib[,c("GlobalID","sonde_id","sonde_other","discrete_or_continuous","pre_post","dts_startstop",colnames(df_Calib)[7:52])]

save(df_Calib, df_CalibData, df_CalibMeta, file = here::here("working","CDFW_CalibrationWorksheet.RData"))
```

This chunk contains the crosswalk for DWR's sonde names and their corresponding sonde ID (i.e., serial number). Grabbed from the 'Master_LabInventory_BothLabs.xlsx' file in DWR's Water Quality Lab SharePoint
```{r DWR sonde name crosswalk}
library(readxl)

rm(list = ls())
'%ni%' = Negate('%in%')

DWR_sondeID <- read_excel(here::here("Raw","Master_LabInventory_BothLabs.xlsx"), sheet = "Sonde Serial #s", col_types = c("text","text"))
colnames(DWR_sondeID) <- c("sonde_id","SondeName")
DWR_sondeID <- rbind.data.frame(DWR_sondeID, data.frame(sonde_id = "14J104011", SondeName = "Chamberlain"))


save(DWR_sondeID, file = here::here("working","DWR_SondeID_crosswalk.Rda"))
```


This chunk imports the "SondeData_StartStopTimes.xlsx" from the DWR Water Quality Lab's SharePoint.
```{r DWR start/stop times}
library(readxl)

rm(list = ls())
'%ni%' = Negate('%in%')

s <- excel_sheets(here::here("Raw","SondeData_StartStopTimes.xlsx"))
s2 <- s[-1]
list_s <- list()
for(i in seq_along(s2)){
  df <- read_excel(here::here("Raw","SondeData_StartStopTimes.xlsx"), sheet = s2[i], skip = 1, col_types = c("text","date",rep("text",8)))
  list_s[[i]] <- df
  rm(df)
}

SS <- do.call(rbind.data.frame, list_s)

### There are some difficulties with the time colums so will standardize them for operability
# First, convert to numeric and force NAs in rows that dont have numbers
SS$start1 <- as.numeric(SS$`Start time`)
SS$end1 <- as.numeric(SS$`end time`)

# Look for early hours (before 10am) and add a colon
SS$start2 <- ifelse(SS$start1 > 1 & SS$start1 <= 999,
                    as.character(paste0(substr(SS$start1,0,1),":",substr(SS$start1,2,3))),
                    NA)
# Look for later hours (after 10am) and add a colon
SS$start2 <- ifelse(SS$start1 > 999 & is.na(SS$start2)==T,
                    as.character(paste0(substr(SS$start1,0,2),":",substr(SS$start1,3,4))),
                    SS$start2)
# Look for early hours (before 10am) and add a colon
SS$end2 <- ifelse(SS$end1 > 1 & SS$end1 <= 999,
                    as.character(paste0(substr(SS$end1,0,1),":",substr(SS$end1,2,3))),
                    NA)
# Look for later hours (after 10am) and add a colon
SS$end2 <- ifelse(SS$end1 > 999 & is.na(SS$end2)==T,
                    as.character(paste0(substr(SS$end1,0,2),":",substr(SS$end1,3,4))),
                    SS$end2)

### Some rows had HH:MM:SS in the excel file and that imported incorrectly
# Manually add the times
SS$start2[which(SS$Station=="TRC" & SS$Date == as.Date("2022-12-29"))] <- "11:43"
SS$end2[which(SS$Station=="TRC" & SS$Date == as.Date("2022-12-29"))] <- "10:43"
SS$start2[which(SS$Station=="WNG" & SS$Date == as.Date("2023-06-20"))] <- "14:00"
SS$end2[which(SS$Station=="WNG" & SS$Date == as.Date("2023-06-20"))] <- "13:15"

### Add the sonde ID to the data frame using the DWR sonde name crosswalk made in previous chunk
load(here::here("working","DWR_SondeID_crosswalk.Rda"))
SS.2 <- merge(SS, DWR_sondeID, by.x = "Installed Sonde", by.y = "SondeName", all.x = T)
SS.2$sonde_id[which(SS.2$`Installed Sonde` == "19C101658")] <- "19C101658"

SS.2$departure_time <- as.POSIXct(strptime(paste(as.character(SS.2$Date),SS.2$start2, sep = " "),
                                           format = "%Y-%m-%d %H:%M", tz = "UTC"))
SS.2$arrival_time <- as.POSIXct(strptime(paste(as.character(SS.2$Date),SS.2$end2, sep = " "),
                                         format = "%Y-%m-%d %H:%M", tz = "UTC"))

DWR.startstop <- SS.2[which(is.na(SS.2$sonde_id)==F & is.na(SS.2$departure_time)==F & is.na(SS.2$arrival_time)==F),
                      c("sonde_id","departure_time","arrival_time","end2")]
save(DWR.startstop, file = here::here("working","DWR_startstop.Rda"))
```

